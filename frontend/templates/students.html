<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ученики</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <style>
        /* Темный фон для main-content */
        .game-main-content {
            background: var(--theme-bg-primary);
            min-height: 100vh;
            padding: 0 !important;
            margin-left: 280px !important;
            width: calc(100% - 280px) !important;
            transition: background-color 0.3s ease;
        }

        body.theme-light .game-main-content {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        /* Адаптация при свернутом sidebar */
        body:has(.sidebar.collapsed) .game-main-content,
        .sidebar.collapsed~.main-content.game-main-content {
            margin-left: 80px !important;
            width: calc(100% - 80px) !important;
        }

        /* Игровой интерфейс стили */
        .game-layout {
            display: flex;
            flex-direction: column;
            gap: 0;
            height: 100vh;
            height: 100dvh;
            background: var(--theme-bg-primary);
            overflow: hidden;
            transition: background-color 0.3s ease;
        }

        body.theme-light .game-layout {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }


        /* Верхняя панель с кнопками */
        .game-top-bar {
            background: var(--theme-bg-secondary);
            border-bottom: 2px solid var(--theme-border);
            transition: background-color 0.3s ease, border-color 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            flex-shrink: 0;
            min-height: 72px;
            box-sizing: border-box;
            margin: 0;
            padding: 16px 24px;
            gap: 10px;
            flex-wrap: nowrap;
        }

        /* Левый спейсер для баланса flex space-between */
        .header-spacer {
            display: none;
        }

        .game-top-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* Кнопки в стиле игры */
        .game-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--theme-bg-tertiary);
            color: var(--theme-text-primary);
            height: 40px;
            box-sizing: border-box;
        }

        .game-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .game-btn-secondary {
            background: var(--theme-bg-tertiary);
            color: var(--theme-text-primary);
        }

        .game-btn-secondary:hover {
            background: var(--theme-bg-tertiary);
            opacity: 0.8;
        }

        .game-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .game-btn-primary:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3f91 100%);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        /* Панель фильтров в стиле игры */
        .game-filter-panel {
            position: fixed;
            top: 0;
            left: 280px;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* Responsive Overrides */
        @media (max-width: 768px) {
            .game-main-content {
                margin-left: 0 !important;
                width: 100% !important;
                padding-bottom: 0 !important;
            }

            .game-layout {
                height: calc(100vh - 70px) !important;
                height: calc(100dvh - 70px) !important;
            }

            .header-spacer {
                display: none !important;
            }

            .game-top-bar {
                height: auto !important;
                padding: 10px !important;
                flex-direction: column !important;
                align-items: flex-end !important;
            }

            .game-top-buttons {
                position: static !important;
                transform: none !important;
                flex-wrap: wrap !important;
                justify-content: flex-end !important;
                gap: 12px !important;
                width: 100% !important;
            }

            .game-btn {
                padding: 8px 12px !important;
                font-size: 13px !important;
            }

            .game-top-buttons .game-btn {
                width: 42px !important;
                height: 42px !important;
                padding: 0 !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                border-radius: 10px !important;
                min-width: 42px !important;
                background: var(--theme-bg-secondary) !important;
                border: 1px solid var(--theme-border) !important;
                color: var(--theme-text-primary) !important;
                box-shadow: none !important;
            }

            .game-top-buttons .game-btn svg {
                width: 20px !important;
                height: 20px !important;
                stroke: var(--theme-text-primary) !important;
            }

            #addStudentBtn {
                display: none !important;
            }

            #mobileAddStudentBtn {
                display: flex !important;
                width: auto !important;
                padding: 8px 12px !important;
                background: var(--theme-bg-secondary) !important;
                border: 1px solid var(--theme-border) !important;
                color: var(--theme-text-primary) !important;
                box-shadow: none !important;
            }

            #mobileAddStudentBtn span:last-child {
                display: none !important;
            }

            .mobile-search-active .game-top-buttons {
                display: none !important;
            }

            .mobile-search-bar {
                display: none;
                width: 100%;
                padding: 5px 0;
            }

            .mobile-search-active .mobile-search-bar {
                display: flex !important;
                align-items: center;
                gap: 10px;
            }

            #mobileSearchInput {
                flex: 1;
                padding: 10px 15px;
                border-radius: 8px;
                border: 1px solid var(--theme-border);
                background: var(--theme-input-bg);
                color: var(--theme-text-primary);
                font-size: 14px;
            }

            /* Улучшенное отображение баланса на мобильном */
            .student-item-meta {
                display: flex !important;
                gap: 8px !important;
                align-items: center !important;
                margin-bottom: 4px !important;
            }

            .student-item-age {
                display: inline-block !important;
                font-size: 11px !important;
                color: #64748b !important;
            }

            .student-item-balance {
                display: inline-block !important;
                margin-left: auto !important;
            }

            .badge-balance,
            .badge-club {
                display: inline-block !important;
                font-size: 13px !important;
                padding: 4px 10px !important;
                border-radius: 6px !important;
                font-weight: 700 !important;
            }

            .student-item-info {
                flex: 1 !important;
                min-width: 0 !important;
                display: flex !important;
                flex-direction: column !important;
            }

            .student-item-group {
                display: block !important;
                font-size: 11px !important;
                color: #64748b !important;
            }

            .game-layout-wrapper {
                flex-direction: column !important;
                overflow-y: auto !important;
                flex: 1;
            }

            .student-list-panel {
                width: 100% !important;
                height: 100% !important;
                flex: 1 !important;
                border-right: none !important;
            }

            .student-list-header {
                display: none !important;
            }

            .students-header-filters .student-group-filter,
            .students-header-filters .student-list-search {
                display: none !important;
            }

            .students-header-filters {
                justify-content: flex-end !important;
                width: 100% !important;
                margin-left: 0 !important;
            }

            .student-details-panel {
                display: none !important;
            }

            .student-photo-panel {
                display: none !important;
            }

            .student-photo-content {
                position: static !important;
                height: auto !important;
                padding: 20px 0 !important;
            }

            .game-filter-panel {
                left: 0 !important;
            }

            .game-filter-content {
                width: 95% !important;
                max-height: 95vh !important;
            }

            .game-filter-body {
                padding: 15px !important;
            }

            .game-filter-row {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }

            #toggleMobileSearch,
            #toggleMobileGroupFilter {
                display: flex !important;
            }

            .student-list-header .student-list-search,
            .student-list-header .student-group-filter {
                display: none !important;
            }

            /* Scrollable tabs for mobile */
            .form-tabs,
            .student-tabs {
                display: flex !important;
                flex-wrap: nowrap !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
                scrollbar-width: none !important;
                /* Firefox */
                -ms-overflow-style: none !important;
                /* IE 10+ */
                gap: 5px !important;
                padding-bottom: 5px !important;
                border-bottom: 1px solid var(--theme-border) !important;
            }

            .form-tabs::-webkit-scrollbar,
            .student-tabs::-webkit-scrollbar {
                display: none !important;
                /* Safari and Chrome */
            }

            .form-tab,
            .student-tab {
                white-space: nowrap !important;
                flex-shrink: 0 !important;
                padding: 10px 15px !important;
                font-size: 13px !important;
            }

            /* Hide modal title for mobile */
            .modal-header-fixed h2 {
                display: none !important;
            }

            .modal-header-fixed {
                justify-content: flex-end !important;
            }

            /* Bottom Sheet Styles */
            .mobile-bottom-sheet-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(4px);
                z-index: 10000;
                display: none;
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .mobile-bottom-sheet-overlay.active {
                display: block;
                opacity: 1;
            }

            .mobile-bottom-sheet {
                position: absolute;
                bottom: -100%;
                left: 0;
                width: 100%;
                background: var(--theme-bg-secondary);
                border-radius: 20px 20px 0 0;
                padding: 20px;
                transition: bottom 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
                box-shadow: 0 -10px 25px rgba(0, 0, 0, 0.2);
            }

            .mobile-bottom-sheet-overlay.active .mobile-bottom-sheet {
                bottom: 0;
            }

            .bottom-sheet-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 1px solid var(--theme-border);
            }

            .bottom-sheet-header h3 {
                margin: 0;
                font-size: 1.1rem;
                color: var(--theme-text-primary);
            }

            .bottom-sheet-list {
                display: flex;
                flex-direction: column;
                gap: 10px;
                max-height: 50vh;
                overflow-y: auto;
            }

            .bottom-sheet-item {
                padding: 14px;
                background: var(--theme-bg-tertiary);
                border-radius: 12px;
                color: var(--theme-text-primary);
                font-size: 14px;
                font-weight: 500;
                border: 1px solid transparent;
                text-align: left;
                width: 100%;
                cursor: pointer;
            }

            .bottom-sheet-item.active {
                border-color: #3b82f6;
                background: rgba(59, 130, 246, 0.1);
                color: #3b82f6;
            }
        }

        /* Адаптация для свернутого sidebar */
        body:has(.sidebar.collapsed) .game-filter-panel,
        .sidebar.collapsed~.main-content .game-filter-panel {
            left: 80px;
        }

        .game-filter-content {
            background: var(--theme-bg-secondary);
            transition: background-color 0.3s ease;
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .game-filter-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            background: var(--theme-bg-primary);
            transition: background-color 0.3s ease;
            border-bottom: 2px solid var(--theme-border);
            transition: border-color 0.3s ease;
        }

        .game-filter-header h3 {
            color: var(--theme-text-primary);
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .game-filter-close {
            background: transparent;
            border: none;
            color: var(--theme-text-tertiary);
            font-size: 24px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .game-filter-close:hover {
            background: var(--theme-bg-tertiary);
            color: var(--theme-text-primary);
        }

        .game-filter-body {
            padding: 24px;
            overflow-y: auto;
            max-height: calc(80vh - 80px);
        }

        .game-filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .game-filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .game-filter-group label {
            color: var(--theme-text-tertiary);
            font-size: 13px;
            font-weight: 500;
        }

        .game-filter-group input,
        .game-filter-group select {
            padding: 10px 14px;
            background: var(--theme-input-bg);
            transition: background-color 0.3s ease;
            border: 1px solid var(--theme-input-border);
            transition: border-color 0.3s ease;
            border-radius: 8px;
            color: var(--theme-text-primary);
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .game-filter-group input:focus,
        .game-filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .game-filter-group input::placeholder {
            color: var(--theme-text-tertiary);
        }

        .game-filter-group select option {
            background: var(--theme-bg-secondary);
            transition: background-color 0.3s ease;
            color: var(--theme-text-primary);
        }

        .game-filter-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .game-layout-wrapper {
            display: flex;
            flex: 1;
            overflow: hidden;
            min-height: 0;
            gap: 0;
        }

        /* Секция 1: Список учеников (Стиль Мессенджера) */
        .student-list-panel {
            width: 340px;
            flex-shrink: 0;
            background: #ffffff;
            /* Чистый белый */
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 2;
        }

        .game-main-content {
            background: #f8fafc !important;
            /* Светло-серый фон для контента */
        }

        body.theme-dark .student-list-panel {
            background: #1e293b;
            border-right-color: #334155;
        }

        /* Секция 2: Параметры ученика */
        .student-details-panel {
            flex: 1;
            min-width: 0;
            overflow-y: auto;
            border-right: 1px solid rgba(148, 163, 184, 0.2);
        }

        /* Секция 3: Фото ученика (фиксированное) */
        .student-photo-panel {
            width: 350px;
            flex-shrink: 0;
            position: relative;
            background: var(--theme-bg-secondary);
            transition: background-color 0.3s ease;
        }

        .student-photo-placeholder-main {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #64748b;
        }

        .student-photo-placeholder-main.hidden {
            display: none;
        }

        .student-photo-content {
            position: sticky;
            top: 0;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .student-photo-content.hidden {
            display: none !important;
        }

        .student-photo-container-fixed {
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 20px;
            min-height: 0;
        }

        .student-photo-wrapper {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            perspective: 1000px;
            height: 240px;
        }

        .student-photo-card {
            position: relative;
            width: 180px;
            height: 240px;
            transform-style: preserve-3d;
            transition: transform 0.6s ease;
            cursor: pointer;
        }

        .student-photo-wrapper:hover .student-photo-card {
            transform: rotateY(180deg);
        }

        .student-photo-front,
        .student-photo-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            overflow: hidden;
        }

        .student-photo-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, var(--theme-bg-secondary) 0%, var(--theme-bg-primary) 100%);
            border: 3px solid #3b82f6;
            box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
        }

        .student-photo-number {
            font-family: 'Bebas Neue', 'Impact', 'Arial Black', sans-serif;
            font-size: 120px;
            font-weight: 900;
            color: #ffffff;
            text-shadow:
                0 0 20px rgba(59, 130, 246, 0.8),
                0 0 40px rgba(59, 130, 246, 0.6),
                0 4px 8px rgba(0, 0, 0, 0.5);
            letter-spacing: -5px;
            line-height: 1;
            text-align: center;
        }


        /* Компонент карточек */
        .student-cards-container {
            width: 100%;
            padding: 0 20px 20px 20px;
            margin-top: auto;
            flex-shrink: 0;
        }

        .student-cards-title {
            color: #94a3b8;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            text-align: center;
        }

        .student-cards-grid {
            display: flex;
            flex-direction: row;
            gap: 6px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .student-card-slot {
            width: 50px;
            height: 70px;
            border: 2px dashed #475569;
            border-radius: 6px;
            background: var(--theme-bg-primary);
            transition: background-color 0.3s ease;
            cursor: pointer;
            transition: all 0.2s ease;
            transform: rotate(8deg);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
        }

        /* Небольшое изменение угла для визуального разнообразия, но все в одну сторону */
        .student-card-slot:nth-child(2) {
            transform: rotate(6deg);
        }

        .student-card-slot:nth-child(3) {
            transform: rotate(10deg);
        }

        .student-card-slot:nth-child(4) {
            transform: rotate(7deg);
        }

        .student-card-slot:nth-child(5) {
            transform: rotate(9deg);
        }

        .student-card-slot:nth-child(6) {
            transform: rotate(8deg);
        }

        .student-card-slot:hover {
            border-color: #64748b;
            transform: rotate(8deg) scale(1.05);
            z-index: 10;
        }

        .student-card-slot.empty {
            opacity: 0.5;
        }

        .student-card-slot.empty:hover {
            opacity: 1;
        }

        .student-card-slot.yellow {
            background: #fbbf24;
            border-color: #f59e0b;
            color: #78350f;
        }

        .student-card-slot.red {
            background: #ef4444;
            border-color: #dc2626;
            color: #ffffff;
        }

        .student-card-slot.orange {
            background: #f97316;
            border-color: #ea580c;
            color: #ffffff;
        }

        .student-card-slot.blue {
            background: #3b82f6;
            border-color: #2563eb;
            color: #ffffff;
        }

        .student-card-slot.green {
            background: #10b981;
            border-color: #059669;
            color: #ffffff;
        }

        .student-card-content {
            text-align: center;
            font-size: 9px;
            font-weight: 700;
            padding: 2px;
            word-break: break-word;
            line-height: 1.1;
        }

        .card-plus-icon {
            font-size: 18px;
            color: #64748b;
            opacity: 0.6;
        }

        .student-card-slot:hover .card-plus-icon {
            opacity: 1;
            color: #94a3b8;
        }

        /* Стили для списка параметров */
        .student-params-container {
            width: 100%;
            padding: 0 20px 20px 20px;
            margin-top: auto;
            flex-shrink: 0;
        }

        .student-params-title {
            color: #94a3b8;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            text-align: center;
        }

        .student-params-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .student-param-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #cbd5e1;
            font-size: 14px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .student-param-item:last-child {
            border-bottom: none;
        }

        .param-icon {
            font-size: 18px;
            line-height: 1;
            flex-shrink: 0;
        }

        .param-name {
            color: #94a3b8;
            font-weight: 500;
            flex-shrink: 0;
            min-width: 120px;
        }

        .param-value {
            color: var(--theme-text-primary);
            font-weight: 600;
            margin-left: auto;
        }

        .student-list-header {
            height: 130px;
            min-height: 130px;
            max-height: 130px;
            flex-shrink: 0;
            padding: 20px 24px 0 24px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-sizing: border-box;
            border-bottom: 1px solid var(--theme-border);
            background: var(--theme-bg-primary);
            position: relative;
            z-index: 10;
        }

        .students-header-filters {
            display: flex;
            gap: 8px;
            align-items: center;
            min-width: 0;
            flex-shrink: 0;
            margin-left: auto;
        }

        .students-header-filters .student-group-filter,
        .students-header-filters .student-list-search {
            width: 150px;
            flex-shrink: 0;
        }

        .mobile-search-bar {
            display: none;
        }

        @media (min-width: 769px) {
            .game-top-bar.mobile-search-active .mobile-search-bar {
                display: none !important;
            }
        }

        .student-list-search input {
            width: 100%;
            padding: 10px 14px;
            background: var(--theme-input-bg);
            transition: background-color 0.3s ease;
            border: 1px solid var(--theme-input-border);
            border-radius: 8px;
            color: var(--theme-text-primary);
            font-size: 14px;
            height: 40px;
            box-sizing: border-box;
        }

        .student-list-search input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .student-group-filter {
            position: relative;
        }

        .student-group-filter select {
            transition: all 0.2s ease;
        }

        .student-group-filter select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        #clearGroupFilter {
            transition: opacity 0.2s ease, background 0.2s ease;
            border-radius: 4px;
        }

        #clearGroupFilter:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        #clearGroupFilter svg {
            transition: stroke 0.2s ease;
        }

        #clearGroupFilter:hover svg {
            stroke: var(--theme-text-primary);
        }

        #groupFilterSelect {
            width: 100%;
            padding: 10px 40px 10px 14px;
            background: var(--theme-input-bg) !important;
            border: 1px solid var(--theme-input-border) !important;
            border-radius: 8px;
            color: var(--theme-text-primary) !important;
            font-size: 14px;
            appearance: none;
            cursor: pointer;
            height: 40px;
            box-sizing: border-box;
        }

        .student-list-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .student-list-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin-bottom: 8px;
            background: var(--theme-bg-secondary);
            transition: background-color 0.3s ease;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .student-list-item:hover {
            background: var(--theme-bg-tertiary);
            border-color: var(--theme-border);
        }

        body.theme-light .student-list-item:hover {
            background: #e2e8f0;
            border-color: #cbd5e1;
        }

        .student-list-item.selected {
            background: #1e40af;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        body.theme-light .student-list-item.selected {
            background: #dbeafe;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        .student-list-item.low-balance {
            border-left: 3px solid #ef4444;
        }

        .student-list-item.blacklisted {
            opacity: 0.6;
            border-left: 3px solid #dc2626;
        }

        .student-item-status {
            display: none;
        }

        .status-icon {
            display: none;
        }

        .student-item-photo {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .student-item-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-placeholder-small {
            width: 100%;
            height: 100%;
            background: #334155;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #94a3b8;
        }

        .student-item-info {
            flex: 1;
            min-width: 0;
        }

        .student-item-name {
            font-weight: 600;
            color: var(--theme-text-primary);
            font-size: 14px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .student-item-meta {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 4px;
        }

        .student-item-age {
            color: var(--theme-text-tertiary);
            font-size: 12px;
        }

        .badge-balance {
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-balance.low {
            background: #ef4444;
        }

        .badge-club {
            background: #8b5cf6;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .student-item-group {
            color: #64748b;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Правая панель: Детали ученика */
        .student-details-panel {
            flex: 1;
            background: var(--theme-bg-primary);
            transition: background-color 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .student-details-placeholder {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #64748b;
        }

        .student-details-placeholder.hidden {
            display: none;
        }

        .placeholder-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .student-details-content {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 0 24px 24px 24px;
            overflow-y: visible;
        }

        .student-details-content.hidden {
            display: none !important;
        }

        .student-details-header {
            height: 130px;
            min-height: 130px;
            max-height: 130px;
            flex-shrink: 0;
            padding-top: 20px;
            padding-bottom: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-sizing: border-box;
            position: sticky;
            top: 0;
            z-index: 11;
            background: var(--theme-bg-primary);
            margin-left: -24px;
            margin-right: -24px;
            padding-left: 24px;
            padding-right: 24px;
            border-bottom: 1px solid var(--theme-border);
            transition: border-color 0.3s ease;
        }

        body.theme-light .student-details-header {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .student-details-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
            margin-bottom: 0;
            padding-bottom: 10px;
            flex: 1;
        }

        .student-details-header>.student-main-info {
            flex: 1;
        }

        .student-details-header>.student-actions-top {
            flex-shrink: 0;
        }

        .student-main-info {
            display: flex;
            align-items: stretch;
            gap: 8px;
            flex: 1;
        }

        /* Блоки значений в ряд */
        .student-info-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            flex: 1;
            min-width: 0;
            padding: 6px 4px;
            background: var(--theme-bg-secondary);
            transition: background-color 0.3s ease;
            border: 1px solid var(--theme-border);
            transition: border-color 0.3s ease;
            border-radius: 6px;
            height: 60px;
        }

        .info-item-label {
            font-size: 8px;
            color: var(--theme-text-tertiary);
            font-weight: 500;
            margin-bottom: 2px;
        }

        .info-item-value {
            font-size: 11px;
            font-weight: 700;
            color: var(--theme-text-primary);
            line-height: 1.2;
            word-break: break-word;
        }

        .info-item-value.balance-positive {
            color: #10b981;
        }

        .info-item-value.balance-negative {
            color: #ef4444;
        }

        .info-item-value .points-icon {
            font-size: 12px;
            margin-right: 2px;
        }

        /* Кнопки действий в правом верхнем углу */
        .student-actions-top {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .student-details-body {
            display: flex;
            flex-direction: column;
            gap: 32px;
            flex: 1;
        }

        .student-name-section {
            margin-bottom: 4px;
        }

        .student-full-name {
            font-size: 28px;
            font-weight: 700;
            color: var(--theme-text-primary);
            margin-bottom: 0;
        }

        .student-basic-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: none;
        }

        .info-label {
            color: var(--theme-text-tertiary);
            font-size: 14px;
        }

        .info-value {
            color: var(--theme-text-primary);
            font-size: 14px;
            font-weight: 500;
        }

        /* Блок с информацией о студенте */
        .student-info-section {
            margin-bottom: 32px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            border-bottom: none;
        }

        @media (max-width: 768px) {
            .info-row {
                grid-template-columns: 1fr;
            }
        }

        .info-group {
            padding: 20px;
            background: #ffffff;
            transition: background-color 0.3s ease;
            border-radius: 12px;
            margin: 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        @media (prefers-color-scheme: dark) {
            .info-group {
                background: var(--theme-bg-secondary);
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            }
        }

        /* Новые чистые карточки данных (вместо рамок) */
        .data-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            border: 1px solid #f1f5f9;
            height: 100%;
            transition: transform 0.2s;
        }

        .data-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        }

        .data-card h4 {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            /* 2 колонки карточек */
            gap: 20px;
            padding: 24px 0;
        }

        /* Темная тема для карточек */
        body.theme-dark .data-card {
            background: #1e293b;
            border-color: #334155;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        body.theme-dark .data-card h4 {
            color: #f1f5f9;
        }

        .info-group-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--theme-text-primary);
            margin-bottom: 16px;
            padding-bottom: 0;
            border-bottom: none;
        }

        .info-group-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .info-item-label {
            color: var(--theme-text-tertiary);
            font-size: 14px;
            font-weight: 500;
        }

        .info-item-text {
            color: var(--theme-text-primary);
            font-size: 14px;
            font-weight: 400;
            text-align: right;
        }

        /* Вкладки */
        .student-tabs-section {
            margin-bottom: 32px;
        }

        .student-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 0;
            margin-top: 0;
            padding-top: 4px;
            padding-bottom: 4px;
            border-bottom: none;
            transition: border-color 0.3s ease;
        }

        .student-details-header .student-tabs {
            margin-left: -24px;
            margin-right: -24px;
            padding-left: 24px;
            padding-right: 24px;
        }

        .student-tab {
            padding: 6px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--theme-text-tertiary);
            transition: all 0.3s ease;
            margin-bottom: -2px;
        }

        .student-tab:hover {
            color: var(--theme-text-primary);
        }

        .student-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            padding-top: 6px;
            padding-bottom: 6px;
        }

        .student-tab-content {
            display: none;
            padding: 20px;
            background: transparent;
            transition: background-color 0.3s ease;
            border-radius: 12px;
        }

        .student-tab-content.active {
            display: block;
            margin-top: 32px;
        }

        /* Вкладки с прокруткой: Оплаты, Вознаграждения, Посещения */
        .student-tab-content[id^="tab-payments-"],
        .student-tab-content[id^="tab-history-"],
        .student-tab-content[id^="tab-attendance-"] {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Кастомный скроллбар для вкладок с прокруткой */
        .student-tab-content[id^="tab-payments-"]::-webkit-scrollbar,
        .student-tab-content[id^="tab-history-"]::-webkit-scrollbar,
        .student-tab-content[id^="tab-attendance-"]::-webkit-scrollbar {
            width: 12px !important;
            height: 12px !important;
            background: transparent !important;
        }

        .student-tab-content[id^="tab-payments-"]::-webkit-scrollbar-track,
        .student-tab-content[id^="tab-history-"]::-webkit-scrollbar-track,
        .student-tab-content[id^="tab-attendance-"]::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5) !important;
            border-radius: 12px !important;
            border: 1px solid rgba(51, 65, 85, 0.5) !important;
            margin: 8px 4px !important;
        }

        .student-tab-content[id^="tab-payments-"]::-webkit-scrollbar-thumb,
        .student-tab-content[id^="tab-history-"]::-webkit-scrollbar-thumb,
        .student-tab-content[id^="tab-attendance-"]::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            border-radius: 12px !important;
            border: 2px solid rgba(30, 41, 59, 0.5) !important;
            min-height: 40px !important;
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.2), 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.3s ease !important;
        }

        .student-tab-content[id^="tab-payments-"]::-webkit-scrollbar-thumb:hover,
        .student-tab-content[id^="tab-history-"]::-webkit-scrollbar-thumb:hover,
        .student-tab-content[id^="tab-attendance-"]::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3f91 100%) !important;
            border-color: rgba(51, 65, 85, 0.7) !important;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.3), 0 3px 6px rgba(0, 0, 0, 0.15) !important;
            transform: scale(1.05) !important;
        }

        /* Светлая тема - скроллбар */
        body.theme-light .student-tab-content[id^="tab-payments-"]::-webkit-scrollbar-track,
        body.theme-light .student-tab-content[id^="tab-history-"]::-webkit-scrollbar-track,
        body.theme-light .student-tab-content[id^="tab-attendance-"]::-webkit-scrollbar-track {
            background: #e5e7eb !important;
            border-radius: 12px !important;
            border: 1px solid #d1d5db !important;
            margin: 8px 4px !important;
        }

        body.theme-light .student-tab-content[id^="tab-payments-"]::-webkit-scrollbar-thumb,
        body.theme-light .student-tab-content[id^="tab-history-"]::-webkit-scrollbar-thumb,
        body.theme-light .student-tab-content[id^="tab-attendance-"]::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            border-radius: 12px !important;
            border: 2px solid #e5e7eb !important;
            min-height: 40px !important;
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.3s ease !important;
        }

        body.theme-light .student-tab-content[id^="tab-payments-"]::-webkit-scrollbar-thumb:hover,
        body.theme-light .student-tab-content[id^="tab-history-"]::-webkit-scrollbar-thumb:hover,
        body.theme-light .student-tab-content[id^="tab-attendance-"]::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3f91 100%) !important;
            border-color: #cbd5e1 !important;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.2), 0 3px 6px rgba(0, 0, 0, 0.15) !important;
            transform: scale(1.05) !important;
        }

        /* Для Firefox */
        .student-tab-content[id^="tab-payments-"],
        .student-tab-content[id^="tab-history-"],
        .student-tab-content[id^="tab-attendance-"] {
            scrollbar-width: thin !important;
            scrollbar-color: #667eea rgba(30, 41, 59, 0.5) !important;
        }

        body.theme-light .student-tab-content[id^="tab-payments-"],
        body.theme-light .student-tab-content[id^="tab-history-"],
        body.theme-light .student-tab-content[id^="tab-attendance-"] {
            scrollbar-width: thin !important;
            scrollbar-color: #667eea #e5e7eb !important;
        }

        .student-tab-content[id^="tab-payments-"]::-webkit-scrollbar-corner,
        .student-tab-content[id^="tab-history-"]::-webkit-scrollbar-corner,
        .student-tab-content[id^="tab-attendance-"]::-webkit-scrollbar-corner {
            background: transparent !important;
        }

        .history-content {
            min-height: 100px;
        }

        .attendance-content {
            min-height: 100px;
        }

        .attendance-calendar-container {
            width: 100%;
        }

        .attendance-months-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 16px;
        }

        @media (max-width: 1400px) {
            .attendance-months-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 900px) {
            .attendance-months-grid {
                grid-template-columns: 1fr;
            }
        }

        .attendance-month-card {
            background: var(--theme-bg-secondary);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--theme-border);
            transition: all 0.3s ease;
        }

        .attendance-month-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .attendance-month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .attendance-day-cell {
            aspect-ratio: 1;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .attendance-day-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .history-section {
            margin-bottom: 32px;
            padding: 20px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        @media (prefers-color-scheme: dark) {
            .history-section {
                background: var(--theme-bg-secondary);
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            }
        }

        .history-section:last-child {
            margin-bottom: 0;
        }

        .history-section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--theme-text-primary);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        }

        .history-list {
            padding: 12px;
            background: var(--theme-bg-primary);
            transition: background-color 0.3s ease;
            border-radius: 8px;
            border: 1px solid rgba(148, 163, 184, 0.15);
            transition: border-color 0.3s ease;
        }

        .show-more-btn {
            width: 100%;
            padding: 12px;
            margin-top: 12px;
            background: var(--theme-bg-secondary);
            transition: background-color 0.3s ease;
            border: 1px solid var(--theme-border);
            transition: border-color 0.3s ease;
            border-radius: 8px;
            color: var(--theme-text-primary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .show-more-btn:hover {
            background: #334155;
            border-color: #475569;
            transform: translateY(-1px);
        }

        /* Элемент списка учеников - Новый дизайн */
        .student-list-item {
            padding: 12px 14px;
            margin: 4px 10px;
            border-radius: 12px;
            background: transparent;
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1px solid transparent;
            position: relative;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .student-list-item:hover {
            background: #f1f5f9;
        }

        .student-list-item.active {
            background: #eff6ff;
            /* Мягкий синий */
            border-color: transparent;
        }

        .student-list-item.active .student-item-name {
            color: #2563eb;
        }

        /* Полоска активного элемента слева */
        .student-list-item.active::before {
            content: '';
            position: absolute;
            left: -10px;
            top: 10%;
            bottom: 10%;
            width: 4px;
            background: #2563eb;
            border-radius: 0 4px 4px 0;
            display: none;
            /* Убираем полоску, делаем заливку */
        }

        /* Аватар в списке */
        .student-list-item .student-avatar-small {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            /* Скругленный квадрат */
            object-fit: cover;
            background: #e2e8f0;
            flex-shrink: 0;
        }

        /* Текстовая часть в списке */
        .student-item-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .student-item-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .student-item-name {
            font-weight: 600;
            font-size: 14px;
            color: #1e293b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .student-item-age {
            font-size: 11px;
            color: #94a3b8;
            background: #f1f5f9;
            padding: 1px 6px;
            border-radius: 4px;
        }

        .student-item-sub {
            font-size: 12px;
            color: #64748b;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .student-item-group {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Темная тема для списка */
        body.theme-dark .student-list-item:hover {
            background: #334155;
        }

        body.theme-dark .student-list-item.active {
            background: #1e3a8a;
        }

        body.theme-dark .student-item-name {
            color: #f1f5f9;
        }

        body.theme-dark .student-list-item.active .student-item-name {
            color: #60a5fa;
        }

        body.theme-dark .student-item-sub {
            color: #94a3b8;
        }

        .history-item {
            padding: 12px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.15);
            transition: background 0.2s ease;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item:hover {
            background: var(--theme-bg-secondary);
            transition: background-color 0.3s ease;
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            gap: 12px;
        }

        .history-item-header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .history-item-title {
            color: var(--theme-text-primary);
            font-weight: 600;
            font-size: 14px;
        }

        .history-item-meta {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }

        .history-item-value {
            color: #f39c12;
            font-weight: 700;
            font-size: 16px;
        }

        .history-item-status {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .history-item-status.active {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .history-item-status.inactive {
            color: #94a3b8;
            background: rgba(148, 163, 184, 0.1);
        }

        .history-card-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        /* Кнопка редактирования оплаты */
        .edit-payment-btn,
        .refund-payment-btn,
        .delete-payment-btn,
        .delete-reward-btn,
        .delete-card-btn {
            width: 32px;
            height: 32px;
            padding: 0;
            background: var(--theme-bg-secondary);
            transition: background-color 0.3s ease;
            border: 1px solid var(--theme-border);
            transition: border-color 0.3s ease;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            outline: none;
        }

        .edit-payment-btn:hover {
            background: #3b82f6;
            border-color: #3b82f6;
        }

        .refund-payment-btn:hover {
            background: #f59e0b;
            border-color: #f59e0b;
        }

        .delete-payment-btn:hover,
        .delete-reward-btn:hover,
        .delete-card-btn:hover {
            background: #ef4444;
            border-color: #ef4444;
        }

        .edit-payment-btn svg,
        .refund-payment-btn svg,
        .delete-payment-btn svg,
        .delete-reward-btn svg,
        .delete-card-btn svg {
            width: 16px;
            height: 16px;
            stroke: #94a3b8;
            transition: stroke 0.2s ease;
        }

        .edit-payment-btn:hover svg,
        .refund-payment-btn:hover svg,
        .delete-payment-btn:hover svg,
        .delete-reward-btn:hover svg,
        .delete-card-btn:hover svg {
            stroke: #ffffff;
        }


        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 16px;
        }

        .financial-info {
            padding: 20px;
            background: var(--theme-bg-secondary);
            transition: background-color 0.3s ease;
            border-radius: 12px;
        }

        .financial-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(148, 163, 184, 0.15);
        }

        .financial-row:last-child {
            border-bottom: none;
        }

        .financial-label {
            color: #94a3b8;
            font-size: 14px;
        }

        body.theme-light .financial-label {
            color: #64748b;
        }

        .financial-value {
            color: #ffffff;
            font-size: 14px;
            font-weight: 500;
        }

        body.theme-light .financial-value {
            color: #1e293b;
        }

        /* Кнопки действий - однотонные с цветом при наведении */
        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border: 1px solid #475569;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #94a3b8;
            background: var(--theme-bg-secondary);
            transition: background-color 0.3s ease;
            white-space: nowrap;
        }

        .action-btn .action-icon {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            flex-shrink: 0;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .action-btn.btn-warning {
            background: var(--theme-bg-secondary);
            transition: background-color 0.3s ease;
            color: #64748b;
            border-color: #475569;
        }

        .action-btn.btn-warning:hover {
            background: #f59e0b;
            color: #ffffff;
            border-color: #f59e0b;
        }

        .action-btn.btn-success {
            background: var(--theme-bg-secondary);
            transition: background-color 0.3s ease;
            color: var(--theme-text-tertiary);
            border-color: var(--theme-border);
        }

        .action-btn.btn-success:hover {
            background: #10b981;
            color: #ffffff;
            border-color: #10b981;
        }

        .action-btn.btn-info {
            background: var(--theme-bg-secondary);
            transition: background-color 0.3s ease;
            color: var(--theme-text-tertiary);
            border-color: var(--theme-border);
        }

        .action-btn.btn-info:hover {
            background: #3b82f6;
            color: #ffffff;
            border-color: #3b82f6;
        }

        .action-btn.btn-danger {
            background: var(--theme-bg-secondary);
            transition: background-color 0.3s ease;
            color: var(--theme-text-tertiary);
            border-color: var(--theme-border);
        }

        .action-btn.btn-danger:hover {
            background: #ef4444;
            color: #ffffff;
            border-color: #ef4444;
        }

        /* Квадратные кнопки для редактирования и удаления */
        .action-btn.edit-student-btn,
        .action-btn.delete-student-btn {
            width: 40px;
            height: 40px;
            padding: 0;
            justify-content: center;
            gap: 0;
        }

        .student-large-photo {
            width: 180px;
            height: 240px;
            object-fit: cover;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .student-photo-placeholder {
            width: 100%;
            height: 100%;
            text-align: center;
            color: #64748b;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: var(--theme-bg-secondary);
            transition: background-color 0.3s ease;
            border-radius: 12px;
        }

        .placeholder-large {
            font-size: 120px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .student-photo-front .student-photo-placeholder p {
            color: #94a3b8;
            font-size: 14px;
            margin: 0;
        }

        /* Кастомный скроллбар для основного контента (стиль из Главной) */
        .student-list-content::-webkit-scrollbar,
        .student-details-content::-webkit-scrollbar,
        .game-filter-body::-webkit-scrollbar {
            width: 12px !important;
            height: 12px !important;
            background: transparent !important;
        }

        /* Темная тема - скроллбар */
        .student-list-content::-webkit-scrollbar-track,
        .student-details-content::-webkit-scrollbar-track,
        .game-filter-body::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5) !important;
            border-radius: 12px !important;
            border: 1px solid rgba(51, 65, 85, 0.5) !important;
            margin: 8px 4px !important;
        }

        .student-list-content::-webkit-scrollbar-thumb,
        .student-details-content::-webkit-scrollbar-thumb,
        .game-filter-body::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            border-radius: 12px !important;
            border: 2px solid rgba(30, 41, 59, 0.5) !important;
            min-height: 40px !important;
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.2), 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.3s ease !important;
        }

        .student-list-content::-webkit-scrollbar-thumb:hover,
        .student-details-content::-webkit-scrollbar-thumb:hover,
        .game-filter-body::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3f91 100%) !important;
            border-color: rgba(51, 65, 85, 0.7) !important;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.3), 0 3px 6px rgba(0, 0, 0, 0.15) !important;
            transform: scale(1.05) !important;
        }

        /* Светлая тема - скроллбар */
        body.theme-light .student-list-content::-webkit-scrollbar-track,
        body.theme-light .student-details-content::-webkit-scrollbar-track,
        body.theme-light .game-filter-body::-webkit-scrollbar-track {
            background: #e5e7eb !important;
            border-radius: 12px !important;
            border: 1px solid #d1d5db !important;
            margin: 8px 4px !important;
        }

        body.theme-light .student-list-content::-webkit-scrollbar-thumb,
        body.theme-light .student-details-content::-webkit-scrollbar-thumb,
        body.theme-light .game-filter-body::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            border-radius: 12px !important;
            border: 2px solid #e5e7eb !important;
            min-height: 40px !important;
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.3s ease !important;
        }

        body.theme-light .student-list-content::-webkit-scrollbar-thumb:hover,
        body.theme-light .student-details-content::-webkit-scrollbar-thumb:hover,
        body.theme-light .game-filter-body::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3f91 100%) !important;
            border-color: #cbd5e1 !important;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.2), 0 3px 6px rgba(0, 0, 0, 0.15) !important;
            transform: scale(1.05) !important;
        }

        /* Для Firefox */
        .student-list-content,
        .student-details-content,
        .game-filter-body {
            scrollbar-width: thin !important;
            scrollbar-color: #667eea rgba(30, 41, 59, 0.5) !important;
        }

        body.theme-light .student-list-content,
        body.theme-light .student-details-content,
        body.theme-light .game-filter-body {
            scrollbar-width: thin !important;
            scrollbar-color: #667eea #e5e7eb !important;
        }

        .student-list-content::-webkit-scrollbar-corner,
        .student-details-content::-webkit-scrollbar-corner,
        .game-filter-body::-webkit-scrollbar-corner {
            background: transparent !important;
        }

        /* Кастомный стиль скроллбара для модальных окон - темный дизайн */
        .modal-content::-webkit-scrollbar,
        .simple-modal::-webkit-scrollbar,
        #paymentModal::-webkit-scrollbar,
        #paymentModal .modal-content::-webkit-scrollbar,
        #editPaymentModal .modal-content::-webkit-scrollbar {
            width: 12px !important;
            height: 12px !important;
            background: transparent !important;
        }

        .modal-content::-webkit-scrollbar-track,
        .simple-modal::-webkit-scrollbar-track,
        #paymentModal::-webkit-scrollbar-track,
        #paymentModal .modal-content::-webkit-scrollbar-track,
        #editPaymentModal .modal-content::-webkit-scrollbar-track {
            background: #e5e7eb !important;
            border-radius: 12px !important;
            border: 1px solid #d1d5db !important;
            margin: 8px 0 !important;
        }

        .modal-content::-webkit-scrollbar-thumb,
        .simple-modal::-webkit-scrollbar-thumb,
        #paymentModal::-webkit-scrollbar-thumb,
        #paymentModal .modal-content::-webkit-scrollbar-thumb,
        #editPaymentModal .modal-content::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            border-radius: 12px !important;
            border: 2px solid #e5e7eb !important;
            min-height: 40px !important;
            box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.3s ease !important;
        }

        .modal-content::-webkit-scrollbar-thumb:hover,
        .simple-modal::-webkit-scrollbar-thumb:hover,
        #paymentModal::-webkit-scrollbar-thumb:hover,
        #paymentModal .modal-content::-webkit-scrollbar-thumb:hover,
        #editPaymentModal .modal-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3f91 100%) !important;
            border-color: #cbd5e1 !important;
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.2), 0 3px 6px rgba(0, 0, 0, 0.15) !important;
            transform: scale(1.05) !important;
        }

        .modal-content::-webkit-scrollbar-corner,
        #paymentModal::-webkit-scrollbar-corner {
            background: transparent !important;
        }

        /* Для Firefox */
        .modal-content,
        .simple-modal,
        #paymentModal,
        #paymentModal .modal-content,
        #editPaymentModal .modal-content {
            scrollbar-width: thin !important;
            scrollbar-color: #667eea #e5e7eb !important;
        }

        /* Кастомный скроллбар для истории оплат */
        .history-list::-webkit-scrollbar,
        [id^="payments-history-"]::-webkit-scrollbar,
        [id^="rewards-history-"]::-webkit-scrollbar,
        [id^="cards-history-"]::-webkit-scrollbar {
            width: 8px !important;
        }

        .history-list::-webkit-scrollbar-track,
        [id^="payments-history-"]::-webkit-scrollbar-track,
        [id^="rewards-history-"]::-webkit-scrollbar-track,
        [id^="cards-history-"]::-webkit-scrollbar-track {
            background: #1e293b !important;
            border-radius: 4px !important;
        }

        .history-list::-webkit-scrollbar-thumb,
        [id^="payments-history-"]::-webkit-scrollbar-thumb,
        [id^="rewards-history-"]::-webkit-scrollbar-thumb,
        [id^="cards-history-"]::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #475569 0%, #334155 100%) !important;
            border-radius: 4px !important;
            border: 1px solid #1e293b !important;
        }

        .history-list::-webkit-scrollbar-thumb:hover,
        [id^="payments-history-"]::-webkit-scrollbar-thumb:hover,
        [id^="rewards-history-"]::-webkit-scrollbar-thumb:hover,
        [id^="cards-history-"]::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #64748b 0%, #475569 100%) !important;
        }

        /* Стили для вкладок формы */
        .form-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
            flex-wrap: wrap;
        }

        .form-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #7f8c8d;
            transition: all 0.3s;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .form-tab svg {
            width: 20px;
            height: 20px;
            stroke: currentColor;
        }

        .form-tab:hover {
            color: #2c3e50;
            background: #f8f9fa;
        }

        .form-tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }

        .form-tab-content {
            display: none;
        }

        .form-tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Улучшенная компактность формы */
        .form-block {
            margin-bottom: 24px;
        }

        .form-block h3 {
            margin-bottom: 16px;
            font-size: 16px;
            color: #1a202c;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            font-size: 13px;
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            font-size: 14px;
            padding: 10px 14px;
        }

        .form-group small {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
            display: block;
        }

        @media (max-width: 1200px) {
            .form-tab-content>div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }
        }

        /* Стили для выбора способа оплаты */
        .payment-method-selector {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .payment-method-option {
            flex: 1;
        }

        .payment-method-label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .payment-method-label:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .payment-method-label input[type="radio"] {
            display: none;
        }

        .payment-method-label input[type="radio"]:checked+.payment-method-text {
            color: #667eea;
            font-weight: 600;
        }

        .payment-method-label:has(input[type="radio"]:checked) {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .payment-method-text {
            font-size: 14px;
            color: #4a5568;
            transition: all 0.3s;
        }

        .payment-method-fields {
            margin-top: 16px;
            padding: 16px;
            background: #f7fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        /* Стили для кнопок типов оплаты */
        .payment-type-btn:hover:not(.active),
        .edit-payment-type-btn:hover:not(.active),
        .finances-payment-type-btn:hover:not(.active) {
            border-color: #667eea !important;
            background: #f7fafc !important;
            color: #667eea !important;
        }

        body.theme-light .payment-type-btn:hover:not(.active),
        body.theme-light .edit-payment-type-btn:hover:not(.active),
        body.theme-light .finances-payment-type-btn:hover:not(.active) {
            border-color: #667eea !important;
            background: #f0f4ff !important;
            color: #667eea !important;
        }

        /* Фиксированные размеры для фото в preview */
        #edit-photo-preview img,
        #add-photo-preview img {
            max-width: 300px !important;
            max-height: 300px !important;
            width: auto !important;
            height: auto !important;
            object-fit: contain !important;
        }

        #edit-photo-preview,
        #add-photo-preview {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            min-height: 200px !important;
        }
    </style>
    <style>
        /* Force unified background */
        .student-photo-panel {
            background: transparent !important;
            border: none !important;
            border-left: 1px solid rgba(203, 213, 225, 0.6) !important;
            /* Тонкая линия разделитель */
            padding-left: 20px !important;
            /* Отступ от линии */
        }

        .student-details-panel {
            background: transparent !important;
            border: none !important;
        }

        /* Restore border for list panel */
        .student-list-panel {
            background: #ffffff !important;
            border-right: 1px solid #cbd5e1 !important;
            position: relative;
            z-index: 10;
        }

        /* Ensure layout flow */
        .game-layout-wrapper {
            background: #f8fafc;
        }
    </style>
    <style>
        /* Remove underline from tabs */
        .student-tab {
            border-bottom: none !important;
        }

        .student-tab.active {
            border-bottom: none !important;
            box-shadow: none !important;
            color: #4f46e5 !important;
            font-weight: 600 !important;
        }

        .student-tab::after {
            display: none !important;
        }

        /* Remove underline from modal tabs */
        .form-tab,
        .form-tab.active,
        .form-tab.active::after {
            border-bottom: none !important;
            box-shadow: none !important;
        }

        .form-tab.active {
            color: #4f46e5 !important;
            font-weight: 600 !important;
            background: transparent !important;
        }

        /* Responsive rows for specific sections */
        @media (max-width: 1200px) {

            #tab-parameters .form-row,
            #edit-tab-parameters .form-row,
            #tab-basic .form-row,
            #edit-tab-basic .form-row {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }

            .form-group label {
                font-size: 12px !important;
            }

            .form-group input,
            .form-group select {
                padding: 8px !important;
                font-size: 13px !important;
            }
        }

        .loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #4f46e5;
            font-size: 14px;
            font-weight: 500;
        }

        /* Force 5 columns in one row for parameters on mobile if needed */
        @media (max-width: 768px) {
            .params-mobile-row-container {
                display: grid !important;
                grid-template-columns: repeat(5, 1fr) !important;
                gap: 5px !important;
                width: 100% !important;
            }

            .params-mobile-row-container .form-group {
                margin-bottom: 0 !important;
            }

            .params-mobile-row-container label {
                font-size: 9px !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }

            .params-mobile-row-container input,
            .params-mobile-row-container select {
                padding: 4px !important;
                font-size: 11px !important;
                height: 32px !important;
            }
        }
    </style>
    <style>
        /* Minimal Students UI */
        .student-list-panel {
            background: #ffffff !important;
            border-right: 1px solid #e2e8f0 !important;
        }

        .student-list-content {
            padding: 10px !important;
        }

        .student-list-item {
            background: #ffffff !important;
            border: 1px solid #e2e8f0 !important;
            border-radius: 12px !important;
            padding: 10px !important;
            margin-bottom: 8px !important;
            box-shadow: none !important;
        }

        .student-list-item:hover {
            background: #f8fafc !important;
            border-color: #cbd5e1 !important;
        }

        .student-list-item.selected {
            background: #eef2ff !important;
            border-color: #c7d2fe !important;
            box-shadow: none !important;
        }

        .student-item-photo {
            width: 44px !important;
            height: 44px !important;
            border-radius: 10px !important;
            background: #f1f5f9 !important;
        }

        .photo-placeholder-small {
            background: #e2e8f0 !important;
            color: #94a3b8 !important;
        }

        .student-item-name {
            font-size: 13px !important;
        }

        .student-item-meta {
            display: flex !important;
            gap: 8px !important;
            align-items: center !important;
            margin-bottom: 4px !important;
        }

        .student-item-age {
            font-size: 11px !important;
            color: #64748b !important;
        }

        .student-item-balance {
            margin-left: auto !important;
        }

        .badge-balance {
            background: #10b981 !important;
            color: white !important;
            padding: 3px 8px !important;
            border-radius: 5px !important;
            font-size: 12px !important;
            font-weight: 600 !important;
            display: inline-block !important;
        }

        .badge-balance.low {
            background: #ef4444 !important;
        }

        .badge-club {
            background: #8b5cf6 !important;
            color: white !important;
            padding: 3px 8px !important;
            border-radius: 5px !important;
            font-size: 12px !important;
            font-weight: 600 !important;
            display: inline-block !important;
        }

        .student-item-group {
            font-size: 11px !important;
            color: #64748b !important;
        }

        .student-details-panel {
            background: #f8fafc !important;
        }

        .student-details-header {
            background: #ffffff !important;
            border-bottom: 1px solid #e2e8f0 !important;
        }

        .student-info-item {
            background: #ffffff !important;
            border: 1px solid #e2e8f0 !important;
            border-radius: 10px !important;
            height: 56px !important;
        }

        .student-full-name {
            font-size: 22px !important;
        }

        .info-group,
        .data-card {
            background: #ffffff !important;
            border: 1px solid #e2e8f0 !important;
            box-shadow: none !important;
        }

        .data-card:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        .student-photo-panel {
            background: #ffffff !important;
            border-left: 1px solid #e2e8f0 !important;
        }

        .student-photo-card {
            width: 160px !important;
            height: 220px !important;
            box-shadow: none !important;
        }

        .student-photo-back {
            border: 1px solid #e2e8f0 !important;
            box-shadow: none !important;
            background: #f8fafc !important;
        }

        .student-photo-wrapper:hover .student-photo-card {
            transform: none !important;
        }

        .student-card-slot {
            transform: none !important;
            border: 1px dashed #cbd5e1 !important;
            background: #f8fafc !important;
            box-shadow: none !important;
        }

        .student-card-slot:nth-child(2),
        .student-card-slot:nth-child(3),
        .student-card-slot:nth-child(4),
        .student-card-slot:nth-child(5),
        .student-card-slot:nth-child(6) {
            transform: none !important;
        }

        .student-card-slot:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        .student-group-header {
            padding: 8px 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #94a3b8;
            background: #1e293b;
            border-radius: 6px;
            margin: 12px 0 8px 0;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        body.theme-light .student-group-header {
            background: #f1f5f9;
            color: #64748b;
        }
    </style>
</head>

<body>
    {% include '_sidebar.html' %}

    <div class="main-content game-main-content">
        <!-- Панель фильтров в стиле игры -->
        <div id="filterPanel" class="game-filter-panel" style="display: none;">
            <div class="game-filter-content">
                <div class="game-filter-header">
                    <h3>🔍 Фильтры</h3>
                    <button type="button" id="closeFilterPanel" class="game-filter-close">✕</button>
                </div>
                <div class="game-filter-body">
                    <div class="game-filter-row">
                        <div class="game-filter-group">
                            <label>🔍 Поиск по имени</label>
                            <input type="text" id="filterName" placeholder="Введите имя или фамилию...">
                        </div>
                        <div class="game-filter-group">
                            <label>👨‍👩‍👦 Группа</label>
                            <select id="filterGroup">
                                <option value="">Все группы</option>
                            </select>
                        </div>
                        <div class="game-filter-group">
                            <label>📊 Статус</label>
                            <select id="filterStatus">
                                <option value="">Все статусы</option>
                                <option value="active">Активен</option>
                                <option value="inactive">Неактивен</option>
                                <option value="blacklist">Чёрный список</option>
                            </select>
                        </div>
                        <div class="game-filter-group">
                            <label>💰 Баланс</label>
                            <select id="filterBalance">
                                <option value="">Все</option>
                                <option value="low">Мало занятий (≤2)</option>
                                <option value="normal">Нормальный (>2)</option>
                                <option value="club">Клубное финансирование</option>
                            </select>
                        </div>
                    </div>
                    <div class="game-filter-actions">
                        <button type="button" id="clearFiltersBtn" class="game-btn game-btn-secondary">🔄
                            Сбросить</button>
                        <button type="button" id="applyFiltersBtn" class="game-btn game-btn-primary">✓
                            Применить</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Игровой интерфейс: две панели -->
        <div class="game-layout">
            <!-- Верхняя панель с кнопками -->
            <div class="game-top-bar">
                <div class="students-header-filters">
                    <div class="student-group-filter">
                        <div style="position: relative;">
                            <select id="groupFilterSelect">
                                <option value="">Все группы</option>
                            </select>
                            <div id="clearGroupFilter"
                                style="position: absolute; right: 30px; top: 50%; transform: translateY(-50%); cursor: pointer; opacity: 0; pointer-events: none; transition: opacity 0.2s; display: flex; align-items: center; justify-content: center; width: 20px; height: 20px;">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                                    style="width: 16px; height: 16px; stroke: #94a3b8;">
                                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </div>
                            <div
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #94a3b8;">
                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                                    style="width: 16px; height: 16px;">
                                    <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="student-list-search">
                        <input type="text" id="studentListSearch" placeholder="🔍 Поиск...">
                    </div>

                    <button id="addStudentBtn" class="game-btn game-btn-primary">
                        <span>
                            <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2.5"
                                fill="none">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </span>
                        <span>Добавить ученика</span>
                    </button>
                </div>
                <div class="game-top-buttons">
                    <button id="toggleMobileGroupFilter" class="game-btn game-btn-secondary"
                        style="display: none; padding: 8px !important;">
                        <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2"
                            fill="none">
                            <path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z"></path>
                        </svg>
                    </button>
                    <button id="toggleMobileSearch" class="game-btn game-btn-secondary"
                        style="display: none; padding: 8px !important;">
                        <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2"
                            fill="none">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                    </button>
                    <button id="mobileAddStudentBtn" class="game-btn game-btn-primary" style="display: none;">
                        <span>
                            <svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2.5"
                                fill="none">
                                <line x1="12" y1="5" x2="12" y2="19"></line>
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                        </span>
                        <span>Добавить ученика</span>
                    </button>
                </div>
                <!-- Мобильная строка поиска -->
                <div class="mobile-search-bar" id="mobileSearchBar">
                    <input type="text" id="mobileSearchInput" placeholder="Поиск ученика...">
                    <button id="closeMobileSearch" class="game-btn game-btn-secondary"
                        style="padding: 8px !important;">✕</button>
                </div>
            </div>

            <!-- Контейнер для трех панелей -->
            <div class="game-layout-wrapper">
                <!-- Секция 1: Список учеников -->
                <div class="student-list-panel">
                    <div class="student-list-content" id="studentListContent">
                        {% set ns = namespace(last_group=None) %}
                        {% for student in students %}
                        {% set current_group = student.group.name if student.group else 'Без группы' %}
                        {% if ns.last_group != current_group %}
                        {% if ns.last_group is not none %}</div>{% endif %}
                    <div class="student-group-section">
                        <div class="student-group-header">{{ current_group }}</div>
                        {% set ns.last_group = current_group %}
                        {% endif %}
                        {% set balance_value = balances.get(student.id) if balances else 0 %}
                        {% set payment = payment_info.get(student.id) if payment_info else None %}
                        {% set points = student_points.get(student.id) if student_points else 0 %}
                        <div class="student-list-item {% if loop.first %}selected{% endif %} {% if balance_value <= 2 %}low-balance{% endif %} {% if student.status == 'blacklist' %}blacklisted{% endif %}"
                            data-student-id="{{ student.id }}" data-group-id="{{ student.group_id or '' }}"
                            data-status="{{ student.status }}" onclick="selectStudent({{ student.id }})">
                            <div class="student-item-status">
                            </div>
                            <div class="student-item-photo">
                                {% if student.photo_path %}
                                <img src="{{ url_for('static', filename='uploads/' + student.photo_path.replace('\\', '/').split('/')[-1]) }}"
                                    alt="{{ student.full_name }}">
                                {% else %}
                                <div class="photo-placeholder-small">👤</div>
                                {% endif %}
                            </div>
                            <div class="student-item-info">
                                <div class="student-item-name">{{ student.full_name }}</div>
                                <div class="student-item-meta">
                                    <span class="student-item-age">{{ 2024 - (student.birth_year or 2024) if
                                        student.birth_year else '-' }} лет</span>
                                    <span class="student-item-balance">
                                        {% if student.club_funded %}
                                        <span class="badge-club">♾️</span>
                                        {% else %}
                                        <span class="badge-balance {% if balance_value <= 2 %}low{% endif %}">{{
                                            balance_value }}</span>
                                        {% endif %}
                                    </span>
                                </div>
                                <div class="student-item-group">{{ student.group.name if student.group else 'Без группы'
                                    }}</div>
                            </div>
                        </div>
                        {% endfor %}
                        {% if ns.last_group is not none %}
                    </div>{% endif %}
                </div>
            </div>

            <!-- Секция 2: Параметры ученика -->
            <div class="student-details-panel" id="studentDetailsPanel">
                <div class="student-details-placeholder {% if students %}hidden{% endif %}">
                    <div class="placeholder-icon">👆</div>
                    <p>Выберите ученика из списка</p>
                </div>

                {% for student in students %}
                {% set balance_value = balances.get(student.id) if balances else 0 %}
                {% set payment = payment_info.get(student.id) if payment_info else None %}
                {% set points = student_points.get(student.id) if student_points else 0 %}
                <div class="student-details-content {% if not loop.first %}hidden{% endif %}"
                    id="studentDetails_{{ student.id }}">
                    <div class="student-details-header">
                        <div class="student-details-header-top">
                            <div class="student-main-info">
                                <!-- Группа -->
                                <div class="student-info-item">
                                    <div class="info-item-label">Группа</div>
                                    <div class="info-item-value">{{ student.group.name if student.group else 'Без
                                        группы' }}</div>
                                </div>
                                <!-- Тариф -->
                                <div class="student-info-item">
                                    <div class="info-item-label">Тариф</div>
                                    <div class="info-item-value">{{ student.tariff.name if student.tariff else 'Не
                                        указан' }}</div>
                                </div>
                                <!-- Баланс -->
                                <div class="student-info-item">
                                    <div class="info-item-label">Баланс</div>
                                    <div
                                        class="info-item-value {% if not student.club_funded %}{% if balance_value > 0 %}balance-positive{% elif balance_value <= 0 %}balance-negative{% endif %}{% endif %}">
                                        {% if student.club_funded %}♾️{% else %}{{ balance_value }}{% endif %}</div>
                                </div>
                                <!-- Статус -->
                                <div class="student-info-item">
                                    <div class="info-item-label">Статус</div>
                                    <div class="info-item-value">
                                        {% if student.status == 'active' %}✓ Активен
                                        {% elif student.status == 'inactive' %}○ Неактивен
                                        {% elif student.status == 'blacklist' %}⚠️ ЧС
                                        {% else %}-{% endif %}
                                    </div>
                                </div>
                                <!-- Баллы -->
                                <div class="student-info-item">
                                    <div class="info-item-label">Баллы</div>
                                    <div class="info-item-value">
                                        <span class="points-icon">⭐</span>{{ points }}
                                    </div>
                                </div>
                                <!-- Telegram код -->
                                <div class="student-info-item">
                                    <div class="info-item-label">Telegram</div>
                                    <div class="info-item-value"
                                        style="display: flex; align-items: center; justify-content: center; gap: 4px; flex-wrap: wrap;">
                                        <button type="button" class="btn-copy-code"
                                            data-code="{{ student.telegram_link_code or '' }}"
                                            data-student-id="{{ student.id }}"
                                            style="width: 20px; height: 20px; padding: 0; background: #f3f4f6; border: none; border-radius: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path
                                                    d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5ZM19 21H8V7H19V21Z"
                                                    fill="#9ca3af" />
                                            </svg>
                                        </button>
                                        <span id="telegram_code_main_{{ student.id }}"
                                            style="font-family: monospace; font-size: 10px; font-weight: 700; color: var(--theme-text-primary);">
                                            {{ student.telegram_link_code or 'Генерируется...' }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="student-actions-top">
                                <button class="action-btn btn-info edit-student-btn" data-student-id="{{ student.id }}">
                                    <svg class="action-icon" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path
                                            d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                        <path
                                            d="M18.5 2.50023C18.8978 2.10243 19.4374 1.87891 20 1.87891C20.5626 1.87891 21.1022 2.10243 21.5 2.50023C21.8978 2.89804 22.1213 3.43762 22.1213 4.00023C22.1213 4.56284 21.8978 5.10243 21.5 5.50023L12 15.0002L8 16.0002L9 12.0002L18.5 2.50023Z"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                    </svg>
                                </button>
                                <button class="action-btn btn-danger delete-student-btn"
                                    data-student-id="{{ student.id }}" data-student-name="{{ student.full_name }}">
                                    <svg class="action-icon" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M3 6H5H21" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round" />
                                        <path
                                            d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z"
                                            stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <!-- Вкладки: Информация, Оплаты, Финансы, Вознаграждения и Посещения -->
                        <div class="student-tabs">
                            <button class="student-tab active" data-tab="info"
                                data-student-id="{{ student.id }}">Информация</button>
                            <button class="student-tab" data-tab="payments"
                                data-student-id="{{ student.id }}">Оплаты</button>
                            <button class="student-tab" data-tab="finances"
                                data-student-id="{{ student.id }}">Финансы</button>
                            <button class="student-tab" data-tab="history"
                                data-student-id="{{ student.id }}">Вознаграждения</button>
                            <button class="student-tab" data-tab="attendance"
                                data-student-id="{{ student.id }}">Посещения</button>
                        </div>
                    </div>

                    <div class="student-details-body">
                        <!-- Вкладки: Информация, Оплаты, Финансы, Вознаграждения и Посещения -->
                        <div class="student-tabs-section">
                            <!-- Вкладка: Информация -->
                            <div class="student-tab-content active" id="tab-info-{{ student.id }}">
                                <div class="student-name-section">
                                    <h2 class="student-full-name">■ {{ student.full_name }}</h2>
                                </div>

                                <!-- Паспортные данные, телефоны и адрес -->
                                <div class="student-info-section">
                                    <!-- Первая строка: Паспортные данные | Телефоны -->
                                    <div class="info-row">
                                        <div class="info-group">
                                            <h4 class="info-group-title">Паспортные данные</h4>
                                            <div class="info-group-content">
                                                <div class="info-item">
                                                    <span class="info-item-label">Серия и номер:</span>
                                                    <span class="info-item-text">{{ (student.passport_series or '')
                                                        + ' ' + (student.passport_number or '') if
                                                        student.passport_series or student.passport_number else '-'
                                                        }}</span>
                                                </div>
                                                <div class="info-item">
                                                    <span class="info-item-label">Кем выдан:</span>
                                                    <span class="info-item-text">{{ student.passport_issued_by or
                                                        '-' }}</span>
                                                </div>
                                                <div class="info-item">
                                                    <span class="info-item-label">Дата выдачи:</span>
                                                    <span class="info-item-text">{{
                                                        student.passport_issue_date|format_date if
                                                        student.passport_issue_date else '-' }}</span>
                                                </div>
                                                <div class="info-item">
                                                    <span class="info-item-label">Срок действия:</span>
                                                    <span class="info-item-text">{{
                                                        student.passport_expiry_date|format_date if
                                                        student.passport_expiry_date else '-' }}</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="info-group">
                                            <h4 class="info-group-title">Телефоны</h4>
                                            <div class="info-group-content">
                                                <div class="info-item">
                                                    <span class="info-item-label">Телефон ученика:</span>
                                                    <div style="display: flex; align-items: center; gap: 8px;">
                                                        <span class="info-item-text">{{ student.phone or '-'
                                                            }}</span>
                                                        {% if student.phone and student.phone != '-' %}
                                                        <button type="button" class="btn-copy-text"
                                                            data-text="{{ student.phone }}"
                                                            style="width: 24px; height: 24px; padding: 0; background: #f3f4f6; border: none; border-radius: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                                                xmlns="http://www.w3.org/2000/svg">
                                                                <path
                                                                    d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5ZM19 21H8V7H19V21Z"
                                                                    fill="#9ca3af" />
                                                            </svg>
                                                        </button>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="info-item">
                                                    <span class="info-item-label">Телефон родителя:</span>
                                                    <div style="display: flex; align-items: center; gap: 8px;">
                                                        <span class="info-item-text">{{ student.parent_phone or '-'
                                                            }}</span>
                                                        {% if student.parent_phone and student.parent_phone != '-'
                                                        %}
                                                        <button type="button" class="btn-copy-text"
                                                            data-text="{{ student.parent_phone }}"
                                                            style="width: 24px; height: 24px; padding: 0; background: #f3f4f6; border: none; border-radius: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none"
                                                                xmlns="http://www.w3.org/2000/svg">
                                                                <path
                                                                    d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5ZM19 21H8V7H19V21Z"
                                                                    fill="#9ca3af" />
                                                            </svg>
                                                        </button>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Вторая строка: Адресные данные | 📱 Telegram -->
                                    <div class="info-row">
                                        <div class="info-group">
                                            <h4 class="info-group-title">Адресные данные</h4>
                                            <div class="info-group-content">
                                                <div class="info-item">
                                                    <span class="info-item-label">Город:</span>
                                                    <span class="info-item-text">{{ student.city or '-' }}</span>
                                                </div>
                                                <div class="info-item">
                                                    <span class="info-item-label">Район:</span>
                                                    <span class="info-item-text">{{ student.district or '-'
                                                        }}</span>
                                                </div>
                                                <div class="info-item">
                                                    <span class="info-item-label">Улица:</span>
                                                    <span class="info-item-text">{{ student.street or '-' }}</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="info-group">
                                            <h4 class="info-group-title">📱 Telegram</h4>
                                            <div class="info-group-content">
                                                <div class="info-item">
                                                    <span class="info-item-label">Telegram:</span>
                                                    <div style="display: flex; align-items: center; gap: 8px;">
                                                        <span class="info-item-text" id="telegram_code_{{ student.id }}"
                                                            style="font-family: monospace; font-size: 16px; font-weight: 600; color: #667eea;">
                                                            {{ student.telegram_link_code or 'Генерируется...' }}
                                                        </span>
                                                        <button type="button" class="btn-copy-code"
                                                            data-code="{{ student.telegram_link_code or '' }}"
                                                            data-student-id="{{ student.id }}"
                                                            style="width: 28px; height: 28px; padding: 0; background: #f3f4f6; border: none; border-radius: 3px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none"
                                                                xmlns="http://www.w3.org/2000/svg">
                                                                <path
                                                                    d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5ZM19 21H8V7H19V21Z"
                                                                    fill="#9ca3af" />
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="info-item">
                                                    <span class="info-item-label">Код для привязки:</span>
                                                    <span class="info-item-text" style="color: #94a3b8;">Отправьте
                                                        этот код ученику</span>
                                                </div>
                                                <div class="info-item">
                                                    <span class="info-item-label">Статус:</span>
                                                    <span class="info-item-text" id="telegram_status_{{ student.id }}">
                                                        {% if student.telegram_chat_id %}
                                                        <span style="color: #10b981;">✅ Привязан</span>
                                                        {% else %}
                                                        <span style="color: #94a3b8;">⏳ Не привязан</span>
                                                        {% endif %}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Вкладка: Оплаты -->
                            <div class="student-tab-content" id="tab-payments-{{ student.id }}">
                                <div class="payments-content">
                                    <div class="history-section">
                                        <div
                                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                            <h4 class="history-section-title" style="margin: 0;">💳 История оплат
                                            </h4>
                                            <button class="game-btn game-btn-primary add-payment-btn"
                                                data-student-id="{{ student.id }}">
                                                <span>➕</span>
                                                <span>Добавить оплату</span>
                                            </button>
                                        </div>
                                        <div id="payments-history-{{ student.id }}" class="history-list">
                                            <p style="color: #94a3b8; text-align: center; padding: 20px;">
                                                Загрузка...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="student-tab-content" id="tab-finances-{{ student.id }}">
                                <div class="financial-info">
                                    <div class="financial-row">
                                        <span class="financial-label">Долг:</span>
                                        <span class="financial-value" id="student-debt-{{ student.id }}">
                                            <span style="color: #94a3b8;">Загрузка...</span>
                                        </span>
                                    </div>
                                    <div class="financial-row">
                                        <span class="financial-label">Тариф:</span>
                                        <span class="financial-value" id="student-tariff-{{ student.id }}">
                                            {{ student.tariff.name if student.tariff else 'Не указан' }}
                                        </span>
                                    </div>
                                    <div class="financial-row">
                                        <span class="financial-label">Дата принятия:</span>
                                        <span class="financial-value">{{ student.admission_date|format_date if
                                            student.admission_date else '-' }}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="student-tab-content" id="tab-history-{{ student.id }}">
                                <div class="history-content">
                                    <!-- История вознаграждений -->
                                    <div class="history-section">
                                        <div
                                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                            <h4 class="history-section-title" style="margin: 0;">⭐ История
                                                вознаграждений</h4>
                                            <button class="game-btn game-btn-primary give-reward-btn"
                                                data-student-id="{{ student.id }}"
                                                style="padding: 8px 16px; font-size: 14px;">
                                                <span>⭐</span>
                                                <span>Выдать вознаграждение</span>
                                            </button>
                                        </div>
                                        <div id="rewards-history-{{ student.id }}" class="history-list">
                                            <p style="color: #94a3b8; text-align: center; padding: 20px;">
                                                Загрузка...</p>
                                        </div>
                                    </div>

                                    <!-- История карточек -->
                                    <div class="history-section">
                                        <h4 class="history-section-title">🟨 История карточек</h4>
                                        <div id="cards-history-{{ student.id }}" class="history-list">
                                            <p style="color: #94a3b8; text-align: center; padding: 20px;">
                                                Загрузка...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="student-tab-content" id="tab-attendance-{{ student.id }}">
                                <div class="attendance-content">
                                    <div class="attendance-calendar-container">
                                        <div class="attendance-year-controls"
                                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding: 16px; background: var(--theme-bg-secondary); border-radius: 12px;">
                                            <button class="game-btn game-btn-secondary"
                                                id="prev-year-btn-{{ student.id }}" style="padding: 8px 16px;">
                                                <span>←</span>
                                                <span id="prev-year-label-{{ student.id }}"></span>
                                            </button>
                                            <h3 style="margin: 0; font-size: 20px; font-weight: 700; color: var(--theme-text-primary);"
                                                id="current-year-label-{{ student.id }}"></h3>
                                            <button class="game-btn game-btn-secondary"
                                                id="next-year-btn-{{ student.id }}" style="padding: 8px 16px;">
                                                <span id="next-year-label-{{ student.id }}"></span>
                                                <span>→</span>
                                            </button>
                                        </div>
                                        <div id="attendance-calendar-{{ student.id }}" class="attendance-calendar-grid">
                                            <p style="color: #94a3b8; text-align: center; padding: 20px;">
                                                Загрузка...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Секция 3: Фото ученика (фиксированное) -->
            <div class="student-photo-panel">
                <div class="student-photo-placeholder-main {% if students %}hidden{% endif %}">
                    <div class="placeholder-icon">👆</div>
                    <p>Выберите ученика</p>
                </div>

                {% for student in students %}
                <div class="student-photo-content {% if not loop.first %}hidden{% endif %}"
                    id="studentPhoto_{{ student.id }}">
                    <div class="student-photo-container-fixed">
                        <!-- Фото сверху -->
                        <div class="student-photo-wrapper">
                            <div class="student-photo-card">
                                <!-- Передняя сторона - фото -->
                                <div class="student-photo-front">
                                    {% if student.photo_path %}
                                    <img src="{{ url_for('static', filename='uploads/' + student.photo_path.replace('\\', '/').split('/')[-1]) }}"
                                        alt="{{ student.full_name }}" class="student-large-photo">
                                    {% else %}
                                    <div class="student-photo-placeholder">
                                        <div class="placeholder-large">👤</div>
                                        <p>Фото отсутствует</p>
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Задняя сторона - номер игрока -->
                                <div class="student-photo-back">
                                    <div class="student-photo-number">
                                        {{ student.student_number.replace('ST', '') if student.student_number and
                                        student.student_number.startswith('ST') else (student.student_number if
                                        student.student_number else '?') }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Карточки снизу -->
                        <div class="student-cards-container" id="studentCards_{{ student.id }}">
                            <div class="student-cards-title">Карточки</div>
                            <div class="student-cards-grid">
                                <!-- 6 слотов для карточек будут заполнены через JavaScript -->
                                {% for i in range(6) %}
                                <div class="student-card-slot empty" data-student-id="{{ student.id }}"
                                    data-slot-index="{{ i }}" onclick="handleCardClick({{ student.id }}, {{ i }})">
                                    <div class="card-plus-icon">+</div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Параметры ученика -->
                        <div class="student-params-container" id="studentParams_{{ student.id }}">
                            <div class="student-params-title">Параметры</div>
                            <div class="student-params-list">
                                <!-- Возраст -->
                                <div class="student-param-item">
                                    <span class="param-icon">🎂</span>
                                    <span class="param-name">Возраст:</span>
                                    <span class="param-value">{{ 2024 - (student.birth_year or 2024) if
                                        student.birth_year else '-' }} {% if student.birth_year %}лет{% endif
                                        %}</span>
                                </div>
                                <!-- Вес -->
                                <div class="student-param-item">
                                    <span class="param-icon">⚖️</span>
                                    <span class="param-name">Вес:</span>
                                    <span class="param-value">{% if student.weight %}{{ student.weight }} кг{% else
                                        %}-{% endif %}</span>
                                </div>
                                <!-- Рост -->
                                <div class="student-param-item">
                                    <span class="param-icon">📏</span>
                                    <span class="param-name">Рост:</span>
                                    <span class="param-value">{% if student.height %}{{ student.height }} см{% else
                                        %}-{% endif %}</span>
                                </div>
                                <!-- Размер футболки -->
                                <div class="student-param-item">
                                    <span class="param-icon">👕</span>
                                    <span class="param-name">Размер футболки:</span>
                                    <span class="param-value">{{ student.jersey_size if student.jersey_size else '-'
                                        }}</span>
                                </div>
                                <!-- Размер шорт -->
                                <div class="student-param-item">
                                    <span class="param-icon">🩳</span>
                                    <span class="param-name">Размер шорт:</span>
                                    <span class="param-value">{{ student.shorts_size if student.shorts_size else '-'
                                        }}</span>
                                </div>
                                <!-- Размер бутс -->
                                <div class="student-param-item">
                                    <span class="param-icon">👟</span>
                                    <span class="param-name">Размер бутс:</span>
                                    <span class="param-value">{{ student.boots_size if student.boots_size else '-'
                                        }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Скрытая таблица для совместимости с существующим JS -->
    <table class="data-table" id="studentsTable" style="display: none;">
        <thead>
            <tr>
                <th>Фото</th>
                <th>Номер</th>
                <th>Имя</th>
                <th>Группа</th>
                <th>Год рождения</th>
                <th>Дата принятия</th>
                <th>Телефон</th>
                <th>Долг</th>
                <th>Баланс</th>
                <th>Баллы</th>
                <th>Статус</th>
                <th>Действия</th>
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
            {% set balance_value = balances.get(student.id) if balances else 0 %}
            <tr class="{% if balance_value <= 2 %}low-balance{% endif %} {% if student.status == 'blacklist' %}blacklisted{% endif %}"
                data-student-id="{{ student.id }}" data-group-id="{{ student.group_id or '' }}"
                data-status="{{ student.status }}">
                <td>
                    {% if student.photo_path %}
                    <img src="{{ url_for('static', filename=student.photo_path.replace('frontend/static/', '').replace('\\', '/')) }}"
                        class="student-avatar">
                    {% else %}
                    <div class="avatar-placeholder">👤</div>
                    {% endif %}
                </td>
                <td><strong>{{ student.student_number }}</strong></td>
                {% set payment = payment_info.get(student.id) if payment_info else None %}
                <td>{{ student.full_name }}</td>
                <td>{{ student.group.name if student.group else 'Без группы' }}</td>
                <td>{{ student.birth_year or '-' }}</td>
                <td>{{ student.admission_date|format_date if student.admission_date else '-' }}</td>
                <td>{{ student.phone or '-' }}</td>
                <td>
                    {% if payment is not none and payment.debt is not none %}
                    {{ payment.debt|format_thousand }}
                    {% else %}-{% endif %}
                </td>
                <td>
                    {% if student.club_funded %}
                    <span class="balance-badge" style="background: #9b59b6;">♾️ Клуб</span>
                    {% else %}
                    <span class="balance-badge {% if balance_value <= 2 %}low{% endif %}">
                        {{ balance_value|format_thousand }}
                    </span>
                    {% endif %}
                </td>
                <td>
                    {% set points = student_points.get(student.id) if student_points else 0 %}
                    <span class="points-badge" style="cursor: pointer; color: #f39c12; font-weight: bold;"
                        data-student-id="{{ student.id }}" onclick="showRewardsHistory({{ student.id }})">
                        ⭐ {{ points }}
                    </span>
                </td>
                <td>
                    {% if student.status == 'active' %}
                    <span style="color: #27ae60;">✓ Активен</span>
                    {% elif student.status == 'inactive' %}
                    <span style="color: #95a5a6;">○ Неактивен</span>
                    {% elif student.status == 'blacklist' %}
                    <span style="color: #e74c3c;">⚠️ ЧС</span>
                    {% endif %}
                </td>
                <td class="action-buttons">
                    <button class="btn-small btn-warning give-reward-btn" data-student-id="{{ student.id }}"
                        title="Выдать вознаграждение">⭐</button>
                    <button class="btn-small btn-success add-payment-btn" data-student-id="{{ student.id }}">💳</button>
                    <button class="btn-small btn-info edit-student-btn" data-student-id="{{ student.id }}">✏️</button>
                    <button class="btn-small btn-danger delete-student-btn" data-student-id="{{ student.id }}"
                        data-student-name="{{ student.full_name }}">🗑️</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </div>

    <!-- Модальное окно: Добавить ученика -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content add-student-modal-content" style="max-width: 1400px; max-height: 95vh;">
            <div class="modal-header-fixed">
                <h2>Добавить ученика</h2>
                <div class="modal-header-actions">
                    <button type="button" class="btn-secondary"
                        onclick="document.getElementById('addStudentModal').style.display='none'">Отмена</button>
                    <button type="submit" form="addStudentForm" class="btn-primary">Сохранить</button>
                </div>
            </div>
            <div class="modal-body-scrollable">
                <form id="addStudentForm" enctype="multipart/form-data">
                    <!-- Вкладки формы -->
                    <div class="form-tabs">
                        <button type="button" class="form-tab active" data-tab="basic">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                stroke-linejoin="round" class="lucide lucide-user-icon lucide-user">
                                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
                                <circle cx="12" cy="7" r="4" />
                            </svg>
                            Основная информация
                        </button>
                        <button type="button" class="form-tab" data-tab="academic">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                stroke-linejoin="round" class="lucide lucide-book-user-icon lucide-book-user">
                                <path d="M15 13a3 3 0 1 0-6 0" />
                                <path
                                    d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H19a1 1 0 0 1 1 1v18a1 1 0 0 1-1 1H6.5a1 1 0 0 1 0-5H20" />
                                <circle cx="12" cy="8" r="2" />
                            </svg>
                            Учебные данные
                        </button>
                        <button type="button" class="form-tab" data-tab="parameters">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                stroke-linejoin="round"
                                class="lucide lucide-chart-column-increasing-icon lucide-chart-column-increasing">
                                <path d="M13 17V9" />
                                <path d="M18 17V5" />
                                <path d="M3 3v16a2 2 0 0 0 2 2h16" />
                                <path d="M8 17v-3" />
                            </svg>
                            Параметры ученика
                        </button>
                        <button type="button" class="form-tab" data-tab="address">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                stroke-linejoin="round" class="lucide lucide-map-pin-icon lucide-map-pin">
                                <path
                                    d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0" />
                                <circle cx="12" cy="10" r="3" />
                            </svg>
                            Адрес
                        </button>
                        <button type="button" class="form-tab" data-tab="passport">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                stroke-linejoin="round" class="lucide lucide-shield-check-icon lucide-shield-check">
                                <path
                                    d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1-1z" />
                                <path d="m9 12 2 2 4-4" />
                            </svg>
                            Паспорт
                        </button>
                    </div>

                    <!-- Содержимое вкладок -->
                    <!-- Вкладка: Основная информация -->
                    <div class="form-tab-content active" id="tab-basic">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <div>
                                <div class="form-group">
                                    <label>Фамилия *</label>
                                    <input type="text" name="last_name" id="last_name" required placeholder="Иванов">
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Имя *</label>
                                        <input type="text" name="first_name" id="first_name" required
                                            placeholder="Иван">
                                    </div>
                                    <div class="form-group">
                                        <label>Отчество</label>
                                        <input type="text" name="middle_name" id="middle_name" placeholder="Иванович">
                                    </div>
                                </div>
                                <input type="hidden" name="full_name" id="full_name_hidden">
                                <div class="form-group">
                                    <label>№ школы</label>
                                    <input type="text" name="school_number" placeholder="Школа № 12">
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Телефон ученика</label>
                                        <input type="tel" name="phone" placeholder="+998 XX XXX XX XX">
                                    </div>
                                    <div class="form-group">
                                        <label>Телефон родителя</label>
                                        <input type="tel" name="parent_phone" placeholder="+998 XX XXX XX XX">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="form-group">
                                    <label>Фото *</label>
                                    <div class="photo-upload-container" id="add-photo-upload" tabindex="0">
                                        <input type="file" name="photo" id="add_photo_input" accept="image/*"
                                            style="display: none;">
                                        <div class="photo-upload-area" id="add-photo-area">
                                            <div class="photo-preview" id="add-photo-preview">
                                                <div class="photo-placeholder">
                                                    <button type="button" class="photo-select-btn"
                                                        id="add-photo-select-btn">
                                                        <span class="photo-select-icon">+</span>
                                                        <span class="photo-select-text">Выбрать</span>
                                                    </button>
                                                    <small class="photo-hint">Или нажмите в любом месте и вставьте фото
                                                        (Ctrl+V)</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <small>Фото должно чётко показывать лицо</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Вкладка: Учебные данные -->
                    <div class="form-tab-content" id="tab-academic">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <div>
                                <div class="form-group" style="display: none;">
                                    <label>Номер ученика</label>
                                    <input type="text" name="student_number" placeholder="ST0001">
                                    <small>Введите уникальный номер, который присваивает администратор</small>
                                </div>
                                <div class="form-group">
                                    <label>Дата принятия</label>
                                    <input type="date" name="admission_date" id="admission_date">
                                </div>
                                <div class="form-group">
                                    <label>Группа</label>
                                    <select name="group_id" id="groupSelect">
                                        <option value="">Без группы</option>
                                    </select>
                                </div>
                                <div class="form-group" style="display: none;">
                                    <label>Статус</label>
                                    <select name="status" id="statusSelect">
                                        <option value="active" selected>Активный</option>
                                        <option value="inactive">Неактивный</option>
                                        <option value="blacklist">Чёрный список</option>
                                    </select>
                                </div>
                                <div class="form-group" id="blacklistReasonBlock" style="display: none;">
                                    <label>Причина добавления в чёрный список</label>
                                    <textarea name="blacklist_reason" rows="3"
                                        placeholder="Опишите причину..."></textarea>
                                </div>
                            </div>
                            <div>
                                <div class="form-group">
                                    <label>Выберите тариф *</label>
                                    <select name="tariff_id" id="tariffSelect" required>
                                        <option value="">Без тарифа</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" name="club_funded" value="true">
                                        <span>Финансирование за счёт клуба</span>
                                    </label>
                                    <small style="display: block; margin-top: 5px; color: #7f8c8d;">
                                        Ученик может посещать занятия без списания баланса
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Вкладка: Параметры ученика -->
                    <div class="form-tab-content" id="tab-parameters">
                        <div class="params-mobile-row-container">
                            <div class="form-group">
                                <label>Рост (см)</label>
                                <input type="number" name="height" min="50" max="250" placeholder="170">
                            </div>
                            <div class="form-group">
                                <label>Вес (кг)</label>
                                <input type="number" name="weight" min="10" max="200" step="0.1" placeholder="65.5">
                            </div>
                            <div class="form-group">
                                <label>Футболка</label>
                                <select name="jersey_size">
                                    <option value="">-</option>
                                    <option value="XS">XS</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                    <option value="XXL">XXL</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Шорты</label>
                                <select name="shorts_size">
                                    <option value="">-</option>
                                    <option value="XS">XS</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                    <option value="XXL">XXL</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Обувь</label>
                                <input type="text" name="boots_size" placeholder="38">
                            </div>
                        </div>

                        <div style="margin-top: 15px;">
                            <div class="form-group">
                                <label>Заметки об экипировке</label>
                                <textarea name="equipment_notes" rows="2" placeholder="Особенности..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Вкладка: Адрес -->
                    <div class="form-tab-content" id="tab-address">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Город</label>
                                        <select name="city" id="citySelect">
                                            <option value="">Выберите город</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Район</label>
                                        <select name="district" id="districtSelect" disabled>
                                            <option value="">Сначала выберите город</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Улица</label>
                                        <input type="text" name="street" placeholder="Название улицы">
                                    </div>
                                    <div class="form-group">
                                        <label>Дом/Квартира</label>
                                        <input type="text" name="house_number" placeholder="Дом 12, кв. 45">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Вкладка: Паспортные данные -->
                    <div class="form-tab-content" id="tab-passport">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <div>
                                <div class="form-group">
                                    <label>Год рождения</label>
                                    <input type="number" name="birth_year" min="1900" max="2025" placeholder="2010">
                                </div>
                                <div class="form-row three-col">
                                    <div class="form-group">
                                        <label>Серия паспорта</label>
                                        <input type="text" name="passport_series" placeholder="AA">
                                    </div>
                                    <div class="form-group">
                                        <label>Номер</label>
                                        <input type="text" name="passport_number" placeholder="1234567">
                                    </div>
                                    <div class="form-group">
                                        <label>Кем выдан</label>
                                        <input type="text" name="passport_issued_by" placeholder="МВД РУз">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Дата выдачи</label>
                                        <input type="date" name="passport_issue_date">
                                    </div>
                                    <div class="form-group">
                                        <label>Срок действия</label>
                                        <input type="date" name="passport_expiry_date">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Модальное окно: Редактировать ученика -->
    <div id="editStudentModal" class="modal">
        <div class="modal-content edit-student-modal-content" style="max-width: 1400px; max-height: 95vh;">
            <div class="modal-header-fixed">
                <h2>Редактировать ученика</h2>
                <div class="modal-header-actions">
                    <button type="button" class="btn-secondary"
                        onclick="document.getElementById('editStudentModal').style.display='none'">Отмена</button>
                    <button type="submit" form="editStudentForm" class="btn-primary">Сохранить</button>
                </div>
            </div>
            <div class="modal-body-scrollable">
                <form id="editStudentForm" enctype="multipart/form-data">
                    <input type="hidden" id="edit_student_id">

                    <!-- Вкладки формы -->
                    <div class="form-tabs">
                        <button type="button" class="form-tab active" data-tab="basic">👤 Основная информация</button>
                        <button type="button" class="form-tab" data-tab="academic">📌 Учебные данные</button>
                        <button type="button" class="form-tab" data-tab="parameters">📏 Параметры ученика</button>
                        <button type="button" class="form-tab" data-tab="address">📍 Адрес</button>
                        <button type="button" class="form-tab" data-tab="passport">🆔 Паспорт</button>
                        <button type="button" class="form-tab" data-tab="history">📜 История</button>
                    </div>

                    <!-- Содержимое вкладок -->
                    <!-- Вкладка: Основная информация -->
                    <div class="form-tab-content active" id="edit-tab-basic">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <div>
                                <div class="form-group">
                                    <label>Фамилия *</label>
                                    <input type="text" id="edit_last_name" required>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Имя *</label>
                                        <input type="text" id="edit_first_name" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Отчество</label>
                                        <input type="text" id="edit_middle_name" placeholder="Иванович">
                                    </div>
                                </div>
                                <input type="hidden" id="edit_full_name" name="full_name" required>
                                <div class="form-group">
                                    <label>№ школы</label>
                                    <input type="text" id="edit_school_number" name="school_number"
                                        placeholder="Школа № 12">
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Телефон</label>
                                        <input type="tel" id="edit_phone" name="phone" placeholder="+998 90 123 45 67">
                                    </div>
                                    <div class="form-group">
                                        <label>Телефон родителя</label>
                                        <input type="tel" id="edit_parent_phone" name="parent_phone"
                                            placeholder="+998 90 123 45 67">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="form-group">
                                    <label>Фото (оставьте пустым, чтобы не менять)</label>
                                    <div class="photo-upload-container" id="edit-photo-upload" tabindex="0">
                                        <input type="file" id="edit_photo" name="photo" accept="image/*"
                                            style="display: none;">
                                        <div class="photo-upload-area" id="edit-photo-area">
                                            <div class="photo-preview" id="edit-photo-preview">
                                                <div class="photo-placeholder">
                                                    <button type="button" class="photo-select-btn"
                                                        id="edit-photo-select-btn">
                                                        <span class="photo-select-icon">+</span>
                                                        <span class="photo-select-text">Выбрать</span>
                                                    </button>
                                                    <small class="photo-hint">Или нажмите в любом месте и вставьте фото
                                                        (Ctrl+V)</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Вкладка: Учебные данные -->
                    <div class="form-tab-content" id="edit-tab-academic">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <div>
                                <div class="form-group">
                                    <label>Номер ученика *</label>
                                    <input type="text" id="edit_student_number" name="student_number" required>
                                    <small>Используйте уникальный номер, известный администраторам</small>
                                </div>
                                <div class="form-group">
                                    <label>Дата принятия</label>
                                    <input type="date" id="edit_admission_date" name="admission_date">
                                </div>
                                <div class="form-group">
                                    <label>Группа</label>
                                    <select id="edit_groupSelect" name="group_id">
                                        <option value="">Без группы</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Статус</label>
                                    <select id="edit_statusSelect" name="status" onchange="toggleEditBlacklistReason()">
                                        <option value="active">Активен</option>
                                        <option value="inactive">Неактивен</option>
                                        <option value="blacklist">Чёрный список</option>
                                    </select>
                                </div>
                                <div id="edit_blacklistReasonBlock" class="form-group" style="display: none;">
                                    <label>Причина добавления в чёрный список</label>
                                    <textarea id="edit_blacklist_reason" name="blacklist_reason" rows="3"
                                        placeholder="Опишите причину..."></textarea>
                                </div>
                            </div>
                            <div>
                                <div class="form-group">
                                    <label>Выберите тариф *</label>
                                    <select id="edit_tariffSelect" name="tariff_id" required>
                                        <option value="">Без тарифа</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="edit_club_funded" name="club_funded" value="true">
                                        <span>Финансирование за счёт клуба</span>
                                    </label>
                                    <small style="display: block; margin-top: 5px; color: #7f8c8d;">
                                        Ученик может посещать занятия без списания баланса
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Вкладка: Параметры ученика -->
                    <div class="form-tab-content" id="edit-tab-parameters">
                        <div class="params-mobile-row-container">
                            <div class="form-group">
                                <label>Рост (см)</label>
                                <input type="number" id="edit_height" name="height" min="50" max="250"
                                    placeholder="170">
                            </div>
                            <div class="form-group">
                                <label>Вес (кг)</label>
                                <input type="number" id="edit_weight" name="weight" min="10" max="200" step="0.1"
                                    placeholder="65.5">
                            </div>
                            <div class="form-group">
                                <label>Футболка</label>
                                <select id="edit_jersey_size" name="jersey_size">
                                    <option value="">-</option>
                                    <option value="XS">XS</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                    <option value="XXL">XXL</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Шорты</label>
                                <select id="edit_shorts_size" name="shorts_size">
                                    <option value="">-</option>
                                    <option value="XS">XS</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                    <option value="XXL">XXL</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Обувь</label>
                                <input type="text" id="edit_boots_size" name="boots_size" placeholder="38">
                            </div>
                        </div>
                    </div>

                    <!-- Вкладка: Адрес -->
                    <div class="form-tab-content" id="edit-tab-address">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Город</label>
                                        <select id="edit_citySelect" name="city">
                                            <option value="">Выберите город</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Район</label>
                                        <select id="edit_districtSelect" name="district" disabled>
                                            <option value="">Сначала выберите город</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Улица</label>
                                        <input type="text" id="edit_street" name="street">
                                    </div>
                                    <div class="form-group">
                                        <label>Дом</label>
                                        <input type="text" id="edit_house_number" name="house_number">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Вкладка: Паспортные данные -->
                    <div class="form-tab-content" id="edit-tab-passport">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <div>
                                <div class="form-group">
                                    <label>Год рождения</label>
                                    <input type="number" id="edit_birth_year" name="birth_year" min="1950" max="2020"
                                        placeholder="2010">
                                </div>
                                <div class="form-row three-col">
                                    <div class="form-group">
                                        <label>Серия</label>
                                        <input type="text" id="edit_passport_series" name="passport_series"
                                            placeholder="AB">
                                    </div>
                                    <div class="form-group">
                                        <label>Номер</label>
                                        <input type="text" id="edit_passport_number" name="passport_number"
                                            placeholder="1234567">
                                    </div>
                                    <div class="form-group">
                                        <label>Кем выдан</label>
                                        <input type="text" id="edit_passport_issued_by" name="passport_issued_by"
                                            placeholder="IIB">
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Дата выдачи</label>
                                        <input type="date" id="edit_passport_issue_date" name="passport_issue_date">
                                    </div>
                                    <div class="form-group">
                                        <label>Срок действия</label>
                                        <input type="date" id="edit_passport_expiry_date" name="passport_expiry_date">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Вкладка: История -->
                    <div class="form-tab-content" id="edit-tab-history">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                            <!-- История вознаграждений -->
                            <div>
                                <h3 style="margin-bottom: 16px; color: #1a202c;">⭐ Вознаграждения</h3>
                                <div id="edit-rewards-history"
                                    style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px;">
                                    <p style="text-align: center; color: #95a5a6; padding: 20px;">Загрузка...</p>
                                </div>
                            </div>

                            <!-- История карточек -->
                            <div>
                                <h3 style="margin-bottom: 16px; color: #1a202c;">🟨 Карточки</h3>
                                <div id="edit-cards-history"
                                    style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px;">
                                    <p style="text-align: center; color: #95a5a6; padding: 20px;">Загрузка...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Модальное окно: Оплата (новая упрощенная версия) -->
    <div id="paymentModal" class="modal">
        <div class="modal-content" style="max-width: 650px; max-height: 90vh;">
            <div class="modal-header-fixed">
                <h2>Добавить оплату</h2>
                <div class="modal-header-actions">
                    <button type="button" class="btn-secondary"
                        onclick="document.getElementById('paymentModal').style.display='none'">Отмена</button>
                    <button type="submit" form="paymentForm" class="btn-primary">Сохранить</button>
                </div>
            </div>
            <div class="modal-body-scrollable">
                <form id="paymentForm">
                    <input type="hidden" id="payment_student_id">

                    <div class="form-group">
                        <label>Год *</label>
                        <select id="payment_year" name="year" required>
                            <option value="">Выберите год</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Месяц *</label>
                        <select id="payment_month" name="month" required>
                            <option value="">Выберите месяц</option>
                            <option value="1">Январь</option>
                            <option value="2">Февраль</option>
                            <option value="3">Март</option>
                            <option value="4">Апрель</option>
                            <option value="5">Май</option>
                            <option value="6">Июнь</option>
                            <option value="7">Июль</option>
                            <option value="8">Август</option>
                            <option value="9">Сентябрь</option>
                            <option value="10">Октябрь</option>
                            <option value="11">Ноябрь</option>
                            <option value="12">Декабрь</option>
                        </select>
                    </div>

                    <!-- Информационный блок о долге за месяц (компактный вид) -->
                    <div id="month-debt-info-block" style="display: none; margin-bottom: 20px;">
                        <div id="debt-info-progress-container"
                            style="position: relative; height: 40px; background: #e9ecef; border-radius: 8px; overflow: hidden; display: flex; align-items: center;">
                            <!-- Зеленая часть - оплачено -->
                            <div id="debt-info-paid-section"
                                style="height: 100%; background: linear-gradient(90deg, #28a745 0%, #20c997 100%); transition: width 0.3s; width: 0%; display: flex; align-items: center; justify-content: center; position: relative; min-width: 0;">
                                <span id="debt-info-paid-text"
                                    style="color: #ffffff; font-weight: 600; font-size: 13px; padding: 0 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">0
                                    сум</span>
                            </div>
                            <!-- Серая часть - остаток -->
                            <div id="debt-info-remainder-section"
                                style="flex: 1; height: 100%; background: #9ca3af; display: flex; align-items: center; justify-content: center; position: relative;">
                                <span id="debt-info-remainder-text"
                                    style="color: #ffffff; font-weight: 600; font-size: 13px; padding: 0 8px; white-space: nowrap;">0
                                    сум</span>
                            </div>
                        </div>
                    </div>

                    <script>
                        // Обработчик выбора месяца для показа информации о долге
                        document.getElementById('payment_month')?.addEventListener('change', function () {
                            if (typeof updateMonthDebtInfo === 'function') {
                                updateMonthDebtInfo();
                            }
                        });

                        // Обработчик выбора года для обновления информации о долге
                        document.getElementById('payment_year')?.addEventListener('change', function () {
                            const month = document.getElementById('payment_month')?.value;
                            if (month && typeof updateMonthDebtInfo === 'function') {
                                updateMonthDebtInfo();
                            }
                        });

                        // Глобальная функция для обновления информации о долге
                        window.updateMonthDebtInfo = async function () {
                            const studentId = document.getElementById('payment_student_id')?.value;
                            const year = document.getElementById('payment_year')?.value;
                            const month = document.getElementById('payment_month')?.value;
                            const debtInfoBlock = document.getElementById('month-debt-info-block');

                            if (!studentId || !year || !month || !debtInfoBlock) {
                                if (debtInfoBlock) debtInfoBlock.style.display = 'none';
                                return;
                            }

                            try {
                                const response = await fetch(`/api/students/${studentId}/monthly-payments`);
                                const data = await response.json();

                                let tariffPrice = 0;
                                let totalPaid = 0;
                                let remainder = 0;

                                if (data.payments_by_month) {
                                    const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                                    const monthData = data.payments_by_month[monthKey];

                                    if (monthData) {
                                        tariffPrice = parseFloat(monthData.tariff_price || 0);
                                        totalPaid = parseFloat(monthData.total_paid || 0);
                                        remainder = parseFloat(monthData.remainder || tariffPrice);
                                    } else {
                                        // Если нет данных за этот месяц, используем тариф ученика
                                        tariffPrice = parseFloat(data.tariff_price || 0);
                                        totalPaid = 0;
                                        remainder = tariffPrice;
                                    }
                                } else {
                                    // Загрузить информацию об ученике для получения тарифа
                                    const studentResponse = await fetch(`/api/students/${studentId}`);
                                    const student = await studentResponse.json();
                                    tariffPrice = parseFloat(student.tariff_price || 0);
                                    totalPaid = 0;
                                    remainder = tariffPrice;
                                }

                                // Обновить отображение
                                if (tariffPrice > 0) {
                                    const paidText = document.getElementById('debt-info-paid-text');
                                    const remainderText = document.getElementById('debt-info-remainder-text');
                                    const paidSection = document.getElementById('debt-info-paid-section');
                                    const remainderSection = document.getElementById('debt-info-remainder-section');

                                    // Вычислить процент оплаты
                                    const progressPercent = Math.min(100, Math.max(0, (totalPaid / tariffPrice * 100)));

                                    // Обновить зеленую часть (оплачено)
                                    paidSection.style.width = progressPercent + '%';
                                    if (totalPaid > 0) {
                                        paidText.textContent = parseFloat(totalPaid).toLocaleString('ru-RU') + ' сум';
                                        paidText.style.display = progressPercent > 15 ? 'block' : 'none'; // Показывать текст только если достаточно места
                                    } else {
                                        paidText.textContent = '';
                                        paidText.style.display = 'none';
                                    }

                                    // Обновить серую часть (остаток)
                                    if (remainder > 0) {
                                        remainderText.textContent = parseFloat(remainder).toLocaleString('ru-RU') + ' сум';
                                        remainderText.style.display = (100 - progressPercent) > 15 ? 'block' : 'none'; // Показывать текст только если достаточно места
                                        remainderSection.style.background = '#9ca3af'; // Серый цвет
                                    } else {
                                        remainderText.textContent = 'Оплачено';
                                        remainderText.style.display = 'block';
                                        remainderSection.style.background = '#28a745'; // Зеленый если полностью оплачено
                                    }

                                    debtInfoBlock.style.display = 'block';
                                } else {
                                    debtInfoBlock.style.display = 'none';
                                }
                            } catch (error) {
                                console.error('Ошибка загрузки информации о долге:', error);
                                if (debtInfoBlock) debtInfoBlock.style.display = 'none';
                            }
                        }
                    </script>

                    <div class="form-group">
                        <label>Дата оплаты *</label>
                        <input type="date" id="payment_date" name="payment_date" required>
                        <small style="color: #7f8c8d; display: block; margin-top: 5px;">Можно выбрать дату от 14 дней
                            назад до сегодня</small>
                    </div>

                    <div class="form-group">
                        <label>Способ оплаты *</label>
                        <div class="payment-method-buttons" style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button type="button" class="payment-type-btn active" data-payment-type="cash"
                                style="flex: 1; min-width: 0; padding: 8px 12px; border: 2px solid #667eea; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; color: #667eea; transition: all 0.3s;">Наличные</button>
                            <button type="button" class="payment-type-btn" data-payment-type="card"
                                style="flex: 1; min-width: 0; padding: 8px 12px; border: 2px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; color: #4a5568; transition: all 0.3s;">Карта</button>
                            <button type="button" class="payment-type-btn" data-payment-type="click"
                                style="flex: 1; min-width: 0; padding: 8px 12px; border: 2px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; color: #4a5568; transition: all 0.3s;">Click</button>
                            <button type="button" class="payment-type-btn" data-payment-type="payme"
                                style="flex: 1; min-width: 0; padding: 8px 12px; border: 2px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; color: #4a5568; transition: all 0.3s;">Payme</button>
                            <button type="button" class="payment-type-btn" data-payment-type="uzum"
                                style="flex: 1; min-width: 0; padding: 8px 12px; border: 2px solid #e2e8f0; background: white; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; color: #4a5568; transition: all 0.3s;">Uzum</button>
                        </div>
                        <input type="hidden" id="selected_payment_type" name="payment_type" value="cash">
                    </div>

                    <!-- Поле для суммы оплаты -->
                    <div class="form-group">
                        <label>Сумма оплаты (сум) *</label>
                        <input type="number" id="payment_amount" name="payment_amount" min="0" step="1000"
                            placeholder="Введите сумму" required>
                        <small id="payment-max-amount" style="color: #7f8c8d; display: none; margin-top: 5px;"></small>
                    </div>

                    <div class="form-group">
                        <label>Примечание</label>
                        <textarea id="payment_notes" name="notes" rows="3"
                            placeholder="Комментарий к оплате"></textarea>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Модальное окно: Редактировать оплату -->
    <div id="editPaymentModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header-fixed">
                <h2>Редактировать оплату</h2>
                <div class="modal-header-actions">
                    <button type="button" class="btn-secondary"
                        onclick="document.getElementById('editPaymentModal').style.display='none'">Отмена</button>
                    <button type="submit" form="editPaymentForm" class="btn-primary">Сохранить</button>
                </div>
            </div>
            <div class="modal-body-scrollable">
                <form id="editPaymentForm">
                    <input type="hidden" id="edit_payment_id">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Дата оплаты</label>
                            <input type="date" id="edit_payment_date" required>
                        </div>
                        <div class="form-group">
                            <label>Сумма (сум) *</label>
                            <input type="number" id="edit_payment_amount" min="0" step="any" required>
                            <div id="edit_payment_amount_error"
                                style="display: none; color: #ef4444; font-size: 12px; margin-top: 4px;"></div>
                        </div>
                    </div>
                    <input type="hidden" id="edit_payment_tariff_price">
                    <input type="hidden" id="edit_payment_payment_month">
                    <input type="hidden" id="edit_payment_payment_year">
                    <div class="form-group">
                        <label>Тип оплаты *</label>
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button type="button" class="edit-payment-type-btn active" data-payment-type="cash"
                                style="flex: 1; min-width: 0; padding: 8px 12px; border: 2px solid #667eea; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; color: #667eea; transition: all 0.3s;">Наличные</button>
                            <button type="button" class="edit-payment-type-btn" data-payment-type="card"
                                style="flex: 1; min-width: 0; padding: 8px 12px; border: 2px solid var(--theme-input-border); background: var(--theme-input-bg); border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--theme-text-primary); transition: all 0.3s;">Карта</button>
                            <button type="button" class="edit-payment-type-btn" data-payment-type="click"
                                style="flex: 1; min-width: 0; padding: 8px 12px; border: 2px solid var(--theme-input-border); background: var(--theme-input-bg); border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--theme-text-primary); transition: all 0.3s;">Click</button>
                            <button type="button" class="edit-payment-type-btn" data-payment-type="payme"
                                style="flex: 1; min-width: 0; padding: 8px 12px; border: 2px solid var(--theme-input-border); background: var(--theme-input-bg); border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--theme-text-primary); transition: all 0.3s;">Payme</button>
                            <button type="button" class="edit-payment-type-btn" data-payment-type="uzum"
                                style="flex: 1; min-width: 0; padding: 8px 12px; border: 2px solid var(--theme-input-border); background: var(--theme-input-bg); border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; color: var(--theme-text-primary); transition: all 0.3s;">Uzum</button>
                        </div>
                        <input type="hidden" id="edit_payment_type" name="payment_type" value="cash" required>
                    </div>
                    <div class="form-group">
                        <label>Примечание</label>
                        <textarea id="edit_payment_notes" rows="2"></textarea>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Модальное окно: Выдать вознаграждение -->
    <div id="giveRewardModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header-fixed">
                <h2>⭐ Выдать вознаграждение</h2>
                <div class="modal-header-actions">
                    <button type="button" class="btn-secondary"
                        onclick="document.getElementById('giveRewardModal').style.display='none'">Отмена</button>
                    <button type="submit" form="giveRewardForm" class="btn-primary">Сохранить</button>
                </div>
            </div>
            <div class="modal-body-scrollable">
                <p id="reward-student-name" style="font-size: 16px; margin-bottom: 20px; color: #2c3e50;"></p>
                <form id="giveRewardForm">
                    <input type="hidden" id="reward_student_id">
                    <div class="form-group">
                        <label>Тип вознаграждения *</label>
                        <select id="reward_type_select" required>
                            <option value="">Выберите тип вознаграждения</option>
                            <!-- Заполнится через JS -->
                        </select>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Модальное окно: История баллов -->
    <div id="rewardsHistoryModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header-fixed">
                <h2>⭐ История баллов</h2>
                <div class="modal-header-actions">
                    <button type="button" class="btn-secondary"
                        onclick="document.getElementById('rewardsHistoryModal').style.display='none'">Закрыть</button>
                </div>
            </div>
            <div class="modal-body-scrollable">
                <p id="history-student-name" style="font-size: 16px; margin-bottom: 20px; color: #2c3e50;"></p>
                <div id="rewardsHistoryList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Заполнится через JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно: Выдать карточку -->
    <div id="giveCardModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header-fixed">
                <h2>🟨 Выдать карточку</h2>
                <div class="modal-header-actions">
                    <button type="button" class="btn-secondary"
                        onclick="document.getElementById('giveCardModal').style.display='none'">Отмена</button>
                    <button type="submit" form="giveCardForm" class="btn-primary">Сохранить</button>
                </div>
            </div>
            <div class="modal-body-scrollable">
                <p id="card-student-name" style="font-size: 16px; margin-bottom: 20px; color: #2c3e50;"></p>
                <form id="giveCardForm">
                    <input type="hidden" id="card_student_id">
                    <input type="hidden" id="card_slot_index">
                    <input type="hidden" id="card_is_remove" value="false">
                    <div class="form-group">
                        <label>Тип карточки *</label>
                        <select id="card_type_select" required>
                            <option value="">Выберите тип карточки</option>
                            <!-- Заполнится через JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Причина *</label>
                        <textarea id="card_reason" rows="3" required
                            placeholder="Укажите причину выдачи карточки"></textarea>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    <script src="{{ url_for('static', filename='js/students.js') }}"></script>
    <script src="{{ url_for('static', filename='js/students_rewards.js') }}"></script>
    <script src="{{ url_for('static', filename='js/students_cards.js') }}"></script>
    <script src="{{ url_for('static', filename='js/students_params.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sidebar.js') }}"></script>
    <script>
        // Сохранение состояния в localStorage
        function savePageState() {
            const selectedStudentId = document.querySelector('.student-list-item.selected')?.getAttribute('data-student-id');
            const studentListContent = document.querySelector('.student-list-content');
            const scrollPosition = studentListContent ? studentListContent.scrollTop : 0;

            if (selectedStudentId) {
                localStorage.setItem('students_page_selected_student', selectedStudentId);
            }
            localStorage.setItem('students_page_scroll_position', scrollPosition.toString());
        }

        // Восстановление состояния из localStorage
        function restorePageState() {
            const savedStudentId = localStorage.getItem('students_page_selected_student');
            const savedScrollPosition = localStorage.getItem('students_page_scroll_position');

            if (savedStudentId) {
                // Небольшая задержка, чтобы DOM успел загрузиться
                setTimeout(() => {
                    const studentItem = document.querySelector(`.student-list-item[data-student-id="${savedStudentId}"]`);
                    if (studentItem) {
                        selectStudent(parseInt(savedStudentId));

                        // Восстановить позицию прокрутки
                        if (savedScrollPosition) {
                            const studentListContent = document.querySelector('.student-list-content');
                            if (studentListContent) {
                                studentListContent.scrollTop = parseInt(savedScrollPosition);
                            }
                        }
                    }
                }, 100);
            }
        }

        // Функция выбора ученика
        function selectStudent(studentId) {
            // Сохранить состояние перед изменением
            savePageState();

            // Убрать выделение со всех элементов списка
            document.querySelectorAll('.student-list-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Выделить выбранный элемент
            const selectedItem = document.querySelector(`.student-list-item[data-student-id="${studentId}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
                // Прокрутить к выбранному элементу
                selectedItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            // Скрыть все панели деталей
            document.querySelectorAll('.student-details-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Скрыть placeholder деталей
            const placeholder = document.querySelector('.student-details-placeholder');
            if (placeholder) {
                placeholder.classList.add('hidden');
            }

            // Показать панель деталей выбранного ученика
            const detailsContent = document.getElementById(`studentDetails_${studentId}`);
            if (detailsContent) {
                detailsContent.classList.remove('hidden');

                // Загрузить данные для активной вкладки
                const activeTab = detailsContent.querySelector('.student-tab.active');
                if (activeTab) {
                    const tabName = activeTab.getAttribute('data-tab');
                    if (tabName === 'payments' && typeof loadStudentPayments === 'function') {
                        loadStudentPayments(studentId);
                    } else if (tabName === 'history' && typeof loadStudentHistory === 'function') {
                        loadStudentHistory(studentId);
                    } else if (tabName === 'finances' && typeof loadStudentDebt === 'function') {
                        loadStudentDebt(studentId);
                    }
                }

                // Всегда загружать долг при выборе студента
                if (typeof loadStudentDebt === 'function') {
                    loadStudentDebt(studentId);
                }
            }

            // Скрыть все фото
            document.querySelectorAll('.student-photo-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Скрыть placeholder фото
            const photoPlaceholderMain = document.querySelector('.student-photo-placeholder-main');
            if (photoPlaceholderMain) {
                photoPlaceholderMain.classList.add('hidden');
            }

            // Показать фото выбранного ученика
            const photoContent = document.getElementById(`studentPhoto_${studentId}`);
            if (photoContent) {
                photoContent.classList.remove('hidden');
            } else {
                // Если фото нет, показать placeholder
                if (photoPlaceholderMain) {
                    photoPlaceholderMain.classList.remove('hidden');
                }
            }

            // Загрузить карточки ученика
            if (typeof loadStudentCardsOnSelect === 'function') {
                loadStudentCardsOnSelect(studentId);
            }
        }



        // Функция фильтрации учеников
        function filterStudentsByGroup(groupId) {
            const items = document.querySelectorAll('.student-list-item');
            const clearBtn = document.getElementById('clearGroupFilter');

            items.forEach(item => {
                const itemGroupId = item.getAttribute('data-group-id');
                const currentDisplay = item.style.display;

                // Если элемент скрыт поиском, не трогать его
                if (currentDisplay === 'none' && !groupId) {
                    // При сбросе фильтра группы проверяем поиск
                    return;
                }

                if (!groupId || itemGroupId === groupId || itemGroupId === '') {
                    // Показывать, если группа совпадает или фильтр не выбран
                    if (currentDisplay !== 'none' || !groupId) {
                        item.style.display = currentDisplay || 'flex';
                    }
                } else {
                    item.style.display = 'none';
                }
            });

            // Показать/скрыть кнопку очистки
            if (clearBtn) {
                if (groupId) {
                    clearBtn.style.opacity = '1';
                    clearBtn.style.pointerEvents = 'auto';
                } else {
                    clearBtn.style.opacity = '0';
                    clearBtn.style.pointerEvents = 'none';
                }
            }

            // Update group visibility
            document.querySelectorAll('.student-group-section').forEach(section => {
                const hasVisibleItems = Array.from(section.querySelectorAll('.student-list-item')).some(item => item.style.display !== 'none');
                section.style.display = hasVisibleItems ? 'block' : 'none';
            });
        }

        // Поиск по списку учеников
        document.addEventListener('DOMContentLoaded', function () {
            // Сохранение позиции прокрутки при скролле
            const studentListContent = document.querySelector('.student-list-content');
            if (studentListContent) {
                let scrollTimeout;
                studentListContent.addEventListener('scroll', function () {
                    // Дебаунс для оптимизации - сохраняем позицию через 100ms после окончания скролла
                    clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => {
                        savePageState();
                    }, 100);
                });
            }

            // Загрузить группы


            // Восстановить состояние страницы после небольшой задержки
            setTimeout(() => {
                restorePageState();
            }, 300);

            // Обработчик фильтрации по группам
            const groupFilterSelect = document.getElementById('groupFilterSelect');
            const clearGroupFilter = document.getElementById('clearGroupFilter');

            if (groupFilterSelect) {
                groupFilterSelect.addEventListener('change', function () {
                    const selectedGroupId = this.value;
                    filterStudentsByGroup(selectedGroupId);

                    // Применить также поиск, если он активен
                    const searchInput = document.getElementById('studentListSearch');
                    if (searchInput && searchInput.value) {
                        searchInput.dispatchEvent(new Event('input'));
                    }
                });
            }

            if (clearGroupFilter) {
                clearGroupFilter.addEventListener('click', function (e) {
                    e.stopPropagation();
                    e.preventDefault();
                    if (groupFilterSelect) {
                        groupFilterSelect.value = '';
                        filterStudentsByGroup('');

                        // Применить также поиск, если он активен
                        const searchInput = document.getElementById('studentListSearch');
                        if (searchInput && searchInput.value) {
                            searchInput.dispatchEvent(new Event('input'));
                        }

                        // Сохранить состояние после сброса фильтра
                        setTimeout(() => savePageState(), 200);
                    }
                });
            }

            const searchInput = document.getElementById('studentListSearch');
            const filterNameInput = document.getElementById('filterName');

            // Синхронизация поиска в списке с фильтром
            if (searchInput) {
                searchInput.addEventListener('input', function (e) {
                    const searchTerm = e.target.value;

                    // Синхронизировать с фильтром имени, если он есть
                    if (filterNameInput) {
                        filterNameInput.value = searchTerm;
                    }

                    // Применить фильтры для полной фильтрации
                    if (typeof applyFilters === 'function') {
                        applyFilters();
                    } else {
                        // Если функция applyFilters еще не загружена, выполнить простой поиск
                        const items = document.querySelectorAll('.student-list-item');
                        const selectedGroupId = groupFilterSelect ? groupFilterSelect.value : '';

                        items.forEach(item => {
                            const name = item.querySelector('.student-item-name').textContent.toLowerCase();
                            const group = item.querySelector('.student-item-group').textContent.toLowerCase();
                            const itemGroupId = item.getAttribute('data-group-id');

                            const matchesSearch = name.includes(searchTerm.toLowerCase()) || group.includes(searchTerm.toLowerCase());
                            const matchesGroup = !selectedGroupId || itemGroupId === selectedGroupId;

                            if (matchesSearch && matchesGroup) {
                                item.style.display = 'flex';
                            } else {
                                item.style.display = 'none';
                            }
                        });

                        // Update group visibility
                        document.querySelectorAll('.student-group-section').forEach(section => {
                            const hasVisibleItems = Array.from(section.querySelectorAll('.student-list-item')).some(item => item.style.display !== 'none');
                            section.style.display = hasVisibleItems ? 'block' : 'none';
                        });
                    }
                });
            }

            // Синхронизация фильтра имени с поиском в списке
            if (filterNameInput && searchInput) {
                filterNameInput.addEventListener('input', function (e) {
                    searchInput.value = e.target.value;
                });
            }

            // Инициализация: выбрать первого ученика, если есть
            const firstItem = document.querySelector('.student-list-item');
            if (firstItem) {
                const studentId = firstItem.getAttribute('data-student-id');
                if (studentId) {
                    // Выбрать первого ученика
                    selectStudent(parseInt(studentId));
                } else {
                    // Если первый ученик не выбран, показать placeholder
                    const placeholder = document.querySelector('.student-details-placeholder');
                    if (placeholder) {
                        placeholder.classList.remove('hidden');
                    }
                    const photoPlaceholder = document.querySelector('.student-photo-placeholder-main');
                    if (photoPlaceholder) {
                        photoPlaceholder.classList.remove('hidden');
                    }
                }
            } else {
                // Нет учеников - показать placeholder
                const placeholder = document.querySelector('.student-details-placeholder');
                if (placeholder) {
                    placeholder.classList.remove('hidden');
                }
                const photoPlaceholder = document.querySelector('.student-photo-placeholder-main');
                if (photoPlaceholder) {
                    photoPlaceholder.classList.remove('hidden');
                }
            }

            // Обработка клавиатурной навигации
            let selectedIndex = 0;
            const studentItems = Array.from(document.querySelectorAll('.student-list-item'));

            document.addEventListener('keydown', function (e) {
                if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                    e.preventDefault();

                    const visibleItems = studentItems.filter(item =>
                        item.style.display !== 'none'
                    );

                    if (visibleItems.length === 0) return;

                    if (e.key === 'ArrowDown') {
                        selectedIndex = (selectedIndex + 1) % visibleItems.length;
                    } else {
                        selectedIndex = (selectedIndex - 1 + visibleItems.length) % visibleItems.length;
                    }

                    const studentId = visibleItems[selectedIndex].getAttribute('data-student-id');
                    if (studentId) {
                        selectStudent(parseInt(studentId));
                    }
                }
            });
        });

        // Переключение вкладок в форме добавления ученика
        document.addEventListener('DOMContentLoaded', function () {
            const addModal = document.getElementById('addStudentModal');
            if (addModal) {
                const tabs = addModal.querySelectorAll('.form-tab');
                tabs.forEach(tab => {
                    tab.addEventListener('click', function () {
                        const tabName = this.getAttribute('data-tab');

                        // Убрать активный класс со всех вкладок
                        tabs.forEach(t => t.classList.remove('active'));
                        addModal.querySelectorAll('.form-tab-content').forEach(content => {
                            content.classList.remove('active');
                        });

                        // Активировать выбранную вкладку
                        this.classList.add('active');
                        const content = addModal.querySelector(`#tab-${tabName}`);
                        if (content) {
                            content.classList.add('active');
                        }
                    });
                });
            }

            // То же самое для формы редактирования
            const editModal = document.getElementById('editStudentModal');
            if (editModal) {
                const tabs = editModal.querySelectorAll('.form-tab');
                tabs.forEach(tab => {
                    tab.addEventListener('click', function () {
                        const tabName = this.getAttribute('data-tab');

                        tabs.forEach(t => t.classList.remove('active'));
                        editModal.querySelectorAll('.form-tab-content').forEach(content => {
                            content.classList.remove('active');
                        });

                        this.classList.add('active');
                        const content = editModal.querySelector(`#edit-tab-${tabName}`);
                        if (content) {
                            content.classList.add('active');

                            // Загрузить историю при открытии вкладки истории
                            if (tabName === 'history') {
                                const studentId = document.getElementById('edit_student_id').value;
                                if (studentId) {
                                    loadEditHistory(studentId);
                                }
                            }
                        }
                    });
                });
            }
        });

        // Загрузка истории для модального окна редактирования
        async function loadEditHistory(studentId) {
            // Загрузить историю вознаграждений (вся история)
            try {
                const rewardsResponse = await fetch(`/api/students/${studentId}/rewards?all=true`);
                const rewards = await rewardsResponse.json();
                const rewardsContainer = document.getElementById('edit-rewards-history');

                if (rewards.length === 0) {
                    rewardsContainer.innerHTML = '<p style="text-align: center; color: #95a5a6; padding: 20px;">Нет выданных вознаграждений</p>';
                } else {
                    rewardsContainer.innerHTML = rewards.map(r => {
                        const date = new Date(r.issued_at);
                        const dateStr = date.toLocaleDateString('ru-RU', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        return `
                            <div style="padding: 12px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: #2c3e50;">${r.reward_name}</strong>
                                    <div style="font-size: 12px; color: #7f8c8d; margin-top: 4px;">
                                        ${dateStr} • Выдал: ${r.issuer_name}
                                    </div>
                                </div>
                                <span style="color: #f39c12; font-weight: bold; font-size: 18px;">+${r.points}</span>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Ошибка загрузки истории вознаграждений:', error);
                document.getElementById('edit-rewards-history').innerHTML =
                    '<p style="text-align: center; color: #e74c3c; padding: 20px;">Ошибка загрузки</p>';
            }

            // Загрузить историю карточек
            try {
                const cardsResponse = await fetch(`/api/students/${studentId}/cards/history`);
                const cards = await cardsResponse.json();
                const cardsContainer = document.getElementById('edit-cards-history');

                if (cards.length === 0) {
                    cardsContainer.innerHTML = '<p style="text-align: center; color: #95a5a6; padding: 20px;">Нет выданных карточек</p>';
                } else {
                    cardsContainer.innerHTML = cards.map(c => {
                        const date = new Date(c.issued_at);
                        const dateStr = date.toLocaleDateString('ru-RU', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        const removedStr = c.removed_at ? new Date(c.removed_at).toLocaleDateString('ru-RU', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : null;

                        const statusColor = c.is_active ? '#10b981' : '#95a5a6';
                        const statusText = c.is_active ? 'Активна' : 'Снята';

                        return `
                            <div style="padding: 12px; border-bottom: 1px solid #e2e8f0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="width: 20px; height: 20px; border-radius: 4px; background: ${getCardColor(c.card_type_color)}; display: inline-block;"></span>
                                        <strong style="color: #2c3e50;">${c.card_type_name}</strong>
                                    </div>
                                    <span style="color: ${statusColor}; font-size: 12px; font-weight: 600;">${statusText}</span>
                                </div>
                                <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 4px;">
                                    <div>Причина: ${c.reason}</div>
                                    <div>Выдана: ${dateStr} • ${c.issued_by}</div>
                                    ${removedStr ? `<div>Снята: ${removedStr}${c.removed_by ? ' • ' + c.removed_by : ''}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Ошибка загрузки истории карточек:', error);
                document.getElementById('edit-cards-history').innerHTML =
                    '<p style="text-align: center; color: #e74c3c; padding: 20px;">Ошибка загрузки</p>';
            }
        }

        function getCardColor(colorName) {
            const colors = {
                'yellow': '#fbbf24',
                'red': '#ef4444',
                'orange': '#f97316',
                'blue': '#3b82f6',
                'green': '#10b981'
            };
            return colors[colorName] || '#64748b';
        }
        // Переключение вкладок в деталях студента
        document.addEventListener('DOMContentLoaded', function () {
            const studentTabs = document.querySelectorAll('.student-tab');

            studentTabs.forEach(tab => {
                tab.addEventListener('click', function () {
                    const tabName = this.getAttribute('data-tab');
                    const studentId = this.getAttribute('data-student-id');
                    const studentDetails = this.closest('.student-details-content');

                    if (!studentDetails || !studentId) return;

                    // Убрать активный класс со всех вкладок этого студента
                    studentDetails.querySelectorAll('.student-tab').forEach(t => t.classList.remove('active'));
                    studentDetails.querySelectorAll('.student-tab-content').forEach(content => content.classList.remove('active'));

                    // Добавить активный класс к выбранной вкладке
                    this.classList.add('active');
                    const content = studentDetails.querySelector(`#tab-${tabName}-${studentId}`);
                    if (content) {
                        content.classList.add('active');

                        // Загрузить данные при открытии вкладки
                        if (tabName === 'history') {
                            loadStudentHistory(studentId);
                        } else if (tabName === 'payments') {
                            loadStudentPayments(studentId);
                        } else if (tabName === 'finances') {
                            loadStudentDebt(studentId);
                        } else if (tabName === 'attendance') {
                            loadStudentAttendance(studentId);
                        }
                    }
                });
            });

            // Загрузить данные для активных вкладок при загрузке страницы
            document.querySelectorAll('.student-tab.active').forEach(activeTab => {
                const tabName = activeTab.getAttribute('data-tab');
                const studentId = activeTab.getAttribute('data-student-id');
                if (studentId && tabName === 'payments') {
                    loadStudentPayments(studentId);
                } else if (studentId && tabName === 'history') {
                    loadStudentHistory(studentId);
                } else if (studentId && tabName === 'finances') {
                    loadStudentDebt(studentId);
                } else if (studentId && tabName === 'attendance') {
                    loadStudentAttendance(studentId);
                }
            });

            // Загрузить долги для всех видимых студентов
            document.querySelectorAll('.student-details-content:not(.hidden)').forEach(content => {
                const studentId = content.id.replace('studentDetails_', '');
                if (studentId && typeof loadStudentDebt === 'function') {
                    loadStudentDebt(studentId);
                }
            });
        });

        // Загрузка долга ученика для вкладки Финансы
        async function loadStudentDebt(studentId) {
            try {
                // Получить информацию об ученике
                const studentResponse = await fetch(`/api/students/${studentId}`);
                const student = await studentResponse.json();

                // Получить данные по оплатам
                const paymentsResponse = await fetch(`/api/students/${studentId}/monthly-payments`);
                const data = await paymentsResponse.json();

                // Отладка: проверить данные тарифа
                console.log('Student tariff_name:', student.tariff_name);
                console.log('Data tariff_name:', data.tariff_name);
                console.log('Student tariff_price:', student.tariff_price);
                console.log('Data tariff_price:', data.tariff_price);

                let totalDebt = 0;
                const tariffPrice = parseFloat(data.tariff_price || student.tariff_price || 0);

                // Получить дату принятия
                let admissionDate = null;
                if (student.admission_date) {
                    admissionDate = new Date(student.admission_date);
                }

                // Получить текущую дату
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth() + 1;

                // Суммировать все остатки по месяцам из оплат
                const paidMonths = new Set();
                if (data.payments_by_month) {
                    Object.keys(data.payments_by_month).forEach(monthKey => {
                        const monthData = data.payments_by_month[monthKey];
                        const remainder = parseFloat(monthData.remainder || 0);
                        if (remainder > 0) {
                            totalDebt += remainder;
                        }

                        // Запомнить месяцы, где есть оплаты
                        const [year, monthNum] = monthKey.split('-').map(Number);
                        paidMonths.add(`${year}-${monthNum}`);
                    });
                }

                // Если есть дата принятия и тариф, проверить месяцы с момента принятия
                if (admissionDate && tariffPrice > 0) {
                    const admissionYear = admissionDate.getFullYear();
                    const admissionMonth = admissionDate.getMonth() + 1;

                    // Пройти по всем месяцам с момента принятия до текущего месяца
                    for (let year = admissionYear; year <= currentYear; year++) {
                        const startMonth = (year === admissionYear) ? admissionMonth : 1;
                        const endMonth = (year === currentYear) ? currentMonth : 12;

                        for (let month = startMonth; month <= endMonth; month++) {
                            const monthKey = `${year}-${month}`;

                            // Если за этот месяц нет оплат, добавить тариф к долгу
                            if (!paidMonths.has(monthKey)) {
                                totalDebt += tariffPrice;
                            }
                        }
                    }
                }

                // Обновить отображение долга
                const debtElement = document.getElementById(`student-debt-${studentId}`);
                if (debtElement) {
                    if (totalDebt > 0) {
                        debtElement.innerHTML = `<span style="color: #e74c3c; font-weight: 600;">${totalDebt.toLocaleString('ru-RU')} сум</span>`;
                    } else {
                        debtElement.innerHTML = `<span style="color: #27ae60; font-weight: 600;">Нет</span>`;
                    }
                }

                // Обновить отображение тарифа с суммой
                const tariffElement = document.getElementById(`student-tariff-${studentId}`);
                if (tariffElement) {
                    // Приоритет: сначала student.tariff_name, потом data.tariff_name
                    let tariffName = null;
                    if (student.tariff_name && String(student.tariff_name).trim() !== '' && student.tariff_name !== 'null') {
                        tariffName = String(student.tariff_name).trim();
                    } else if (data.tariff_name && String(data.tariff_name).trim() !== '' && data.tariff_name !== 'null') {
                        tariffName = String(data.tariff_name).trim();
                    }

                    // Если название не найдено в API, извлекаем его из текущего текста элемента
                    // (удаляем цену в скобках, если она есть)
                    if (!tariffName) {
                        const currentText = tariffElement.textContent.trim();
                        // Удаляем цену в скобках и лишние пробелы
                        const textWithoutPrice = currentText.replace(/\([^)]*\)/g, '').trim();
                        if (textWithoutPrice && textWithoutPrice !== 'Не указан' && textWithoutPrice !== 'Загрузка...') {
                            tariffName = textWithoutPrice;
                        }
                    }

                    const isLightTheme = document.body.classList.contains('theme-light');
                    const priceColor = isLightTheme ? '#475569' : '#64748b';

                    // Всегда полностью заменяем содержимое элемента
                    if (tariffName && tariffPrice > 0) {
                        tariffElement.innerHTML = `${tariffName} <span style="color: ${priceColor}; font-weight: 600;">(${tariffPrice.toLocaleString('ru-RU')} сум)</span>`;
                    } else if (tariffName) {
                        tariffElement.innerHTML = tariffName;
                    } else if (tariffPrice > 0) {
                        tariffElement.innerHTML = `Не указан <span style="color: ${priceColor}; font-weight: 600;">(${tariffPrice.toLocaleString('ru-RU')} сум)</span>`;
                    } else {
                        tariffElement.innerHTML = 'Не указан';
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки долга:', error);
                const debtElement = document.getElementById(`student-debt-${studentId}`);
                if (debtElement) {
                    debtElement.innerHTML = '<span style="color: #e74c3c;">Ошибка загрузки</span>';
                }
            }
        }

        // Загрузка истории оплат для вкладки оплат
        async function loadStudentPayments(studentId) {
            try {
                const paymentsResponse = await fetch(`/api/students/${studentId}/monthly-payments`);
                const data = await paymentsResponse.json();
                const paymentsContainer = document.getElementById(`payments-history-${studentId}`);

                if (!paymentsContainer) return;

                // Извлечь все платежи из помесячной структуры
                let allPayments = [];
                if (data.payments_by_month) {
                    Object.keys(data.payments_by_month).forEach(monthKey => {
                        const month = data.payments_by_month[monthKey];
                        if (month.payments && month.payments.length > 0) {
                            month.payments.forEach(payment => {
                                allPayments.push({
                                    ...payment,
                                    id: payment.id,
                                    payment_date: payment.date,
                                    amount_paid: payment.amount,
                                    payment_type: payment.payment_type || 'cash',
                                    notes: payment.notes || '',
                                    tariff_name: payment.tariff_name || ''
                                });
                            });
                        }
                    });
                }

                // Если нет платежей, просто показываем пустой список

                // Сортировать по дате (новые сначала)
                allPayments.sort((a, b) => {
                    const dateA = new Date(a.payment_date || a.date);
                    const dateB = new Date(b.payment_date || b.date);
                    return dateB - dateA;
                });

                if (allPayments.length === 0) {
                    paymentsContainer.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;">Нет оплат</p>';
                } else {
                    // Показывать только первые 5 записей, остальные скрыты
                    const initialLimit = 5;
                    const visiblePayments = allPayments.slice(0, initialLimit);
                    const hiddenPayments = allPayments.slice(initialLimit);
                    const hasMore = hiddenPayments.length > 0;

                    let html = visiblePayments.map(p => {
                        const paymentDate = p.payment_date || p.date;
                        const date = new Date(paymentDate);
                        const dateStr = date.toLocaleDateString('ru-RU', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        const amountValue = parseFloat(p.amount_paid || p.amount || 0);
                        const amount = Math.abs(amountValue).toLocaleString('ru-RU');
                        const method = p.payment_type || p.payment_method || 'cash';
                        const methodNames = {
                            'cash': 'Наличные',
                            'card': 'Карта',
                            'click': 'Click',
                            'payme': 'Payme',
                            'uzum': 'Uzum'
                        };
                        const methodDisplay = methodNames[method] || method;

                        // Определить, является ли это возвратом
                        const isRefund = amountValue < 0 || (p.notes && p.notes.toLowerCase().includes('возврат'));

                        // Сохранить данные оплаты в data-атрибутах для использования при редактировании
                        const paymentData = JSON.stringify({
                            id: p.id,
                            amount_paid: p.amount_paid || p.amount,
                            payment_date: paymentDate,
                            payment_type: p.payment_type || 'cash',
                            notes: p.notes || '',
                            tariff_name: p.tariff_name || ''
                        });

                        // Стили для возврата
                        const refundStyle = isRefund ? 'text-decoration: line-through; opacity: 0.7;' : '';
                        const titleText = isRefund ? 'Возврат средств' : 'Оплата';
                        const amountColor = isRefund ? '#ef4444' : '#10b981';
                        const buttonsHtml = isRefund ? '' : `
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button class="edit-payment-btn" data-payment-id="${p.id}" data-student-id="${studentId}" data-payment-data='${paymentData}' title="Редактировать оплату">
                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M18.5 2.50023C18.8978 2.10243 19.4374 1.87891 20 1.87891C20.5626 1.87891 21.1022 2.10243 21.5 2.50023C21.8978 2.89804 22.1213 3.43762 22.1213 4.00023C22.1213 4.56284 21.8978 5.10243 21.5 5.50023L12 15.0002L8 16.0002L9 12.0002L18.5 2.50023Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                                <button class="refund-payment-btn" data-payment-id="${p.id}" data-student-id="${studentId}" data-payment-amount="${p.amount_paid || p.amount}" title="Возврат оплаты">
                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M3 12L21 12M3 12L8 7M3 12L8 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                                <button class="delete-payment-btn" data-payment-id="${p.id}" data-student-id="${studentId}" title="Удалить оплату">
                                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M3 6H5H21M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </button>
                            </div>
                        `;

                        return `
                            <div class="history-item">
                                <div class="history-item-header">
                                    <div>
                                        <div class="history-item-title" style="${refundStyle}">${titleText}</div>
                                        <div class="history-item-meta" style="${refundStyle}">${dateStr} • ${methodDisplay}</div>
                                        ${p.notes ? `<div class="history-item-meta" style="margin-top: 4px; ${refundStyle}">${p.notes}</div>` : ''}
                                        ${p.tariff_name ? `<div class="history-item-meta" style="margin-top: 4px; ${refundStyle}">Тариф: ${p.tariff_name}</div>` : ''}
                                    </div>
                                    <div class="history-item-header-right">
                                        <div class="history-item-value" style="color: ${amountColor}; ${refundStyle}">${amount} сум</div>
                                        ${buttonsHtml}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    // Добавить кнопку и скрытые записи
                    if (hiddenPayments.length > 0) {
                        const hiddenCount = hiddenPayments.length;
                        html += `
                            <button class="show-more-btn" data-student-id="${studentId}" style="width: 100%; padding: 12px; margin-top: 12px; background: var(--theme-bg-secondary); border: 1px solid var(--theme-border); border-radius: 8px; color: var(--theme-text-primary); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; text-align: center;">
                                Показать ещё (${hiddenCount})
                            </button>
                            <div id="hidden-payments-${studentId}" style="display: none;">
                                ${hiddenPayments.map(p => {
                            const paymentDate = p.payment_date || p.date;
                            const date = new Date(paymentDate);
                            const dateStr = date.toLocaleDateString('ru-RU', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });

                            const amountValue = parseFloat(p.amount_paid || p.amount || 0);
                            const amount = Math.abs(amountValue).toLocaleString('ru-RU');
                            const method = p.payment_type || p.payment_method || 'cash';
                            const methodNames = {
                                'cash': 'Наличные',
                                'card': 'Карта',
                                'click': 'Click',
                                'payme': 'Payme',
                                'uzum': 'Uzum'
                            };
                            const methodDisplay = methodNames[method] || method;
                            const isRefund = amountValue < 0 || (p.notes && p.notes.toLowerCase().includes('возврат'));
                            const paymentData = JSON.stringify({
                                id: p.id,
                                amount_paid: p.amount_paid || p.amount,
                                payment_date: paymentDate,
                                payment_type: p.payment_type || 'cash',
                                notes: p.notes || '',
                                tariff_name: p.tariff_name || ''
                            });
                            const refundStyle = isRefund ? 'text-decoration: line-through; opacity: 0.7;' : '';
                            const titleText = isRefund ? 'Возврат средств' : 'Оплата';
                            const amountColor = isRefund ? '#ef4444' : '#10b981';
                            const buttonsHtml = isRefund ? '' : `
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <button class="edit-payment-btn" data-payment-id="${p.id}" data-student-id="${studentId}" data-payment-data='${paymentData}' title="Редактировать оплату">
                                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                    <path d="M18.5 2.50023C18.8978 2.10243 19.4374 1.87891 20 1.87891C20.5626 1.87891 21.1022 2.10243 21.5 2.50023C21.8978 2.89804 22.1213 3.43762 22.1213 4.00023C22.1213 4.56284 21.8978 5.10243 21.5 5.50023L12 15.0002L8 16.0002L9 12.0002L18.5 2.50023Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            </button>
                                            <button class="refund-payment-btn" data-payment-id="${p.id}" data-student-id="${studentId}" data-payment-amount="${p.amount_paid || p.amount}" title="Возврат оплаты">
                                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M3 12L21 12M3 12L8 7M3 12L8 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            </button>
                                            <button class="delete-payment-btn" data-payment-id="${p.id}" data-student-id="${studentId}" title="Удалить оплату">
                                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M3 6H5H21M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            </button>
                                        </div>
                                    `;
                            return `
                                        <div class="history-item">
                                            <div class="history-item-header">
                                                <div>
                                                    <div class="history-item-title" style="${refundStyle}">${titleText}</div>
                                                    <div class="history-item-meta" style="${refundStyle}">${dateStr} • ${methodDisplay}</div>
                                                    ${p.notes ? `<div class="history-item-meta" style="margin-top: 4px; ${refundStyle}">${p.notes}</div>` : ''}
                                                    ${p.tariff_name ? `<div class="history-item-meta" style="margin-top: 4px; ${refundStyle}">Тариф: ${p.tariff_name}</div>` : ''}
                                                </div>
                                                <div class="history-item-header-right">
                                                    <div class="history-item-value" style="color: ${amountColor}; ${refundStyle}">${amount} сум</div>
                                                    ${buttonsHtml}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                        }).join('')}
                            </div>
                        `;

                    }

                    paymentsContainer.innerHTML = html;

                    // Обработчик кнопки "Показать ещё"
                    const showMoreBtn = paymentsContainer.querySelector('.show-more-btn');
                    if (showMoreBtn) {
                        showMoreBtn.addEventListener('click', function () {
                            const hiddenDiv = document.getElementById(`hidden-payments-${studentId}`);
                            if (hiddenDiv) {
                                hiddenDiv.style.display = 'block';
                            }
                            const allHidden = paymentsContainer.querySelectorAll('.history-item[style*="display: none"]');
                            allHidden.forEach(item => {
                                item.style.display = 'block';
                            });
                            this.style.display = 'none';
                        });
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки истории оплат:', error);
                const paymentsContainer = document.getElementById(`payments-history-${studentId}`);
                if (paymentsContainer) {
                    paymentsContainer.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 20px;">Ошибка загрузки</p>';
                }
            }
        }

        // Загрузка истории для вкладки истории
        async function loadStudentHistory(studentId) {
            // Загрузить историю вознаграждений
            try {
                const rewardsResponse = await fetch(`/api/students/${studentId}/rewards?all=true`);
                const rewards = await rewardsResponse.json();
                const rewardsContainer = document.getElementById(`rewards-history-${studentId}`);

                if (!rewardsContainer) return;

                if (rewards.length === 0) {
                    rewardsContainer.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;">Нет выданных вознаграждений</p>';
                } else {
                    rewardsContainer.innerHTML = rewards.map(r => {
                        const date = new Date(r.issued_at);
                        const dateStr = date.toLocaleDateString('ru-RU', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        // Проверка, удалено ли вознаграждение
                        const isDeleted = r.is_deleted || r.deleted_at;
                        const deletedStyle = isDeleted ? 'text-decoration: line-through; opacity: 0.6; color: #94a3b8;' : '';

                        return `
                            <div class="history-item" ${isDeleted ? 'style="opacity: 0.6;"' : ''}>
                                <div class="history-item-header">
                                    <div>
                                        <div class="history-item-title" style="${deletedStyle}">${isDeleted ? '—' : ''} ${r.reward_name} ${isDeleted ? '—' : ''}</div>
                                        <div class="history-item-meta" style="${deletedStyle}">${dateStr} • Выдал: ${r.issuer_name}</div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div class="history-item-value" style="${deletedStyle}">+${r.points}</div>
                                        ${!isDeleted ? `
                                            <button type="button" class="delete-reward-btn" data-reward-id="${r.id}" data-student-id="${studentId}" title="Удалить вознаграждение">
                                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M3 6H5H21M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Ошибка загрузки истории вознаграждений:', error);
                const rewardsContainer = document.getElementById(`rewards-history-${studentId}`);
                if (rewardsContainer) {
                    rewardsContainer.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 20px;">Ошибка загрузки</p>';
                }
            }

            // Загрузить историю карточек
            try {
                const cardsResponse = await fetch(`/api/students/${studentId}/cards/history`);
                const cards = await cardsResponse.json();
                const cardsContainer = document.getElementById(`cards-history-${studentId}`);

                if (!cardsContainer) return;

                if (cards.length === 0) {
                    cardsContainer.innerHTML = '<p style="text-align: center; color: #94a3b8; padding: 20px;">Нет выданных карточек</p>';
                } else {
                    cardsContainer.innerHTML = cards.map(c => {
                        const date = new Date(c.issued_at);
                        const dateStr = date.toLocaleDateString('ru-RU', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        const removedStr = c.removed_at ? new Date(c.removed_at).toLocaleDateString('ru-RU', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : null;

                        const statusClass = c.is_active ? 'active' : 'inactive';
                        const statusText = c.is_active ? 'Активна' : 'Снята';

                        // Проверка, удалена ли карточка
                        const isDeleted = c.is_deleted || c.deleted_at;
                        const deletedStyle = isDeleted ? 'text-decoration: line-through; opacity: 0.6; color: #94a3b8;' : '';

                        return `
                            <div class="history-item" ${isDeleted ? 'style="opacity: 0.6;"' : ''}>
                                <div class="history-item-header">
                                    <div style="display: flex; align-items: center;">
                                        <span class="history-card-color" style="background: ${getCardColor(c.card_type_color)};"></span>
                                        <div class="history-item-title" style="${deletedStyle}">${isDeleted ? '—' : ''} ${c.card_type_name} ${isDeleted ? '—' : ''}</div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span class="history-item-status ${statusClass}" style="${deletedStyle}">${statusText}</span>
                                        ${!isDeleted ? `
                                            <button type="button" class="delete-card-btn" data-card-id="${c.id}" data-student-id="${studentId}" title="Удалить карточку">
                                                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M3 6H5H21M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                                <div class="history-item-meta" style="${deletedStyle}">
                                    <div>Причина: ${c.reason}</div>
                                    <div>Выдана: ${dateStr} • ${c.issued_by}</div>
                                    ${removedStr ? `<div>Снята: ${removedStr}${c.removed_by ? ' • ' + c.removed_by : ''}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Ошибка загрузки истории карточек:', error);
                const cardsContainer = document.getElementById(`cards-history-${studentId}`);
                if (cardsContainer) {
                    cardsContainer.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 20px;">Ошибка загрузки</p>';
                }
            }
        }

        // Загрузка календаря посещений
        const attendanceYears = {}; // Хранить год для каждого ученика

        async function loadStudentAttendance(studentId) {
            const calendarContainer = document.getElementById(`attendance-calendar-${studentId}`);
            const yearLabel = document.getElementById(`current-year-label-${studentId}`);
            const prevYearLabel = document.getElementById(`prev-year-label-${studentId}`);
            const nextYearLabel = document.getElementById(`next-year-label-${studentId}`);

            if (!calendarContainer) return;

            // Установить текущий год для этого ученика
            if (!attendanceYears[studentId]) {
                attendanceYears[studentId] = new Date().getFullYear();
            }
            const attendanceYear = attendanceYears[studentId];

            // Обновить метки годов
            if (yearLabel) yearLabel.textContent = attendanceYear;
            if (prevYearLabel) prevYearLabel.textContent = attendanceYear - 1;
            if (nextYearLabel) nextYearLabel.textContent = attendanceYear + 1;

            try {
                // Загрузить данные студента
                const studentResponse = await fetch(`/api/students/${studentId}`);
                const studentData = await studentResponse.json();

                // Получить дату приема
                let admissionDate = null;
                if (studentData.admission_date) {
                    const admDateStr = studentData.admission_date.split('T')[0];
                    const [admYear, admMonth, admDay] = admDateStr.split('-').map(Number);
                    admissionDate = new Date(admYear, admMonth - 1, admDay);
                }

                // Получить ID группы
                const groupId = studentData.group_id;

                // Загрузить данные группы, если есть group_id
                let scheduleDays = [];
                let scheduleTime = null;

                if (groupId) {
                    try {
                        const groupsResponse = await fetch('/api/groups');
                        if (groupsResponse.ok) {
                            const groups = await groupsResponse.json();
                            const group = groups.find(g => g.id === groupId);
                            if (group) {
                                scheduleDays = group.schedule_days || [];
                                scheduleTime = group.schedule_time || null;
                            }
                        }
                    } catch (groupError) {
                        console.error('Ошибка загрузки группы:', groupError);
                    }
                }

                // Загрузить посещения
                const attendanceResponse = await fetch(`/api/attendance/all?student_id=${studentId}&year=${attendanceYear}`);
                const attendances = await attendanceResponse.json();

                // Создать набор дат посещений (берем date, если нет — день из check_in_time)
                const attendanceDates = new Set();
                attendances.forEach(att => {
                    if (att.date) {
                        attendanceDates.add(att.date);
                        return;
                    }
                    if (att.check_in_time) {
                        try {
                            const parsed = new Date(att.check_in_time);
                            if (!Number.isNaN(parsed.getTime())) {
                                const key = `${parsed.getFullYear()}-${String(parsed.getMonth() + 1).padStart(2, '0')}-${String(parsed.getDate()).padStart(2, '0')}`;
                                attendanceDates.add(key);
                            }
                        } catch (e) {
                            console.error('Не удалось распарсить check_in_time', att.check_in_time, e);
                        }
                    }
                });

                // Получить текущее локальное время для отладки
                const now = new Date();
                const localTimeStr = now.toLocaleString('ru-RU', { timeZone: 'Asia/Tashkent' });

                console.log('=== ATTENDANCE CALENDAR DEBUG ===');
                console.log('Current local time:', localTimeStr);
                console.log('Current Date object:', now);
                console.log('Student ID:', studentId);
                console.log('Group ID:', groupId);
                console.log('Schedule Days:', scheduleDays);
                console.log('Schedule Time:', scheduleTime);
                console.log('Admission Date:', admissionDate);
                console.log('Attendances count:', attendances.length);
                console.log('Attendance dates:', Array.from(attendanceDates));
                console.log('Year:', attendanceYear);

                // Отрисовать календарь
                renderAttendanceCalendar(calendarContainer, attendanceYear, attendanceDates, scheduleDays, scheduleTime, admissionDate);

                // Настроить обработчики кнопок переключения года
                const prevYearBtn = document.getElementById(`prev-year-btn-${studentId}`);
                const nextYearBtn = document.getElementById(`next-year-btn-${studentId}`);

                if (prevYearBtn) {
                    prevYearBtn.onclick = () => {
                        attendanceYears[studentId]--;
                        loadStudentAttendance(studentId);
                    };
                }

                if (nextYearBtn) {
                    nextYearBtn.onclick = () => {
                        attendanceYears[studentId]++;
                        loadStudentAttendance(studentId);
                    };
                }

            } catch (error) {
                console.error('Ошибка загрузки посещений:', error);
                calendarContainer.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 20px;">Ошибка загрузки</p>';
            }
        }

        function renderAttendanceCalendar(container, year, attendanceDates, scheduleDays = [], scheduleTime = null, admissionDate = null) {
            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
            const dayNames = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];

            // Функция для проверки, что дата не раньше даты приема
            function isAfterAdmission(date) {
                if (!admissionDate) return true; // Если нет даты приема, показываем все дни
                const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());
                const admissionOnly = new Date(admissionDate.getFullYear(), admissionDate.getMonth(), admissionDate.getDate());
                return dateOnly >= admissionOnly;
            }

            // Функция для определения, является ли день днем занятия по расписанию группы
            function isLessonDay(date) {
                if (!scheduleDays || scheduleDays.length === 0) {
                    return false; // Нет расписания группы - не день занятия
                }
                // JavaScript getDay(): 0=Вс, 1=Пн, 2=Вт, 3=Ср, 4=Чт, 5=Пт, 6=Сб
                // Наша система: 1=Пн, 2=Вт, 3=Ср, 4=Чт, 5=Пт, 6=Сб, 7=Вс
                let jsDay = date.getDay(); // 0-6
                let ourDay;
                if (jsDay === 0) {
                    ourDay = 7; // Воскресенье
                } else {
                    ourDay = jsDay; // Понедельник-Суббота
                }
                const result = scheduleDays.includes(ourDay);
                return result;
            }

            let html = '<div class="attendance-months-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">';

            for (let month = 0; month < 12; month++) {
                const monthNum = month + 1;
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startDayOfWeek = (firstDay.getDay() + 6) % 7; // Понедельник = 0

                html += `
                    <div class="attendance-month-card" style="background: var(--theme-bg-secondary); border-radius: 12px; padding: 16px; border: 1px solid var(--theme-border);">
                        <h4 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 700; color: var(--theme-text-primary); text-align: center;">
                            ${monthNames[month]}
                        </h4>
                        <div class="attendance-month-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">
                `;

                // Заголовки дней недели
                dayNames.forEach(day => {
                    html += `<div style="text-align: center; font-size: 11px; font-weight: 600; color: var(--theme-text-secondary); padding: 4px;">${day}</div>`;
                });

                // Пустые ячейки до первого дня месяца
                for (let i = 0; i < startDayOfWeek; i++) {
                    html += '<div style="aspect-ratio: 1; border-radius: 4px;"></div>';
                }

                // Дни месяца
                const today = new Date();
                const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(monthNum).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const date = new Date(year, month, day);
                    const hasAttendance = attendanceDates.has(dateStr);
                    const isToday = dateStr === todayStr;
                    const isAfterAdm = isAfterAdmission(date);
                    const isLesson = isLessonDay(date); // День занятия по расписанию группы
                    const isPastOrToday = date <= today;

                    // Отладка для декабря текущего года
                    const currentYear = new Date().getFullYear();
                    if (year === currentYear && month === 11 && day >= 8 && day <= 12) {
                        const dayOfWeek = date.getDay();
                        const ourDay = dayOfWeek === 0 ? 7 : dayOfWeek;
                        console.log(`Day ${day}: dateStr=${dateStr}, isAfterAdm=${isAfterAdm}, isLesson=${isLesson}, isPastOrToday=${isPastOrToday}, hasAttendance=${hasAttendance}, dayOfWeek=${dayOfWeek} (ourDay=${ourDay}), scheduleDays=[${scheduleDays.join(',')}], scheduleTime=${scheduleTime}`);
                    }

                    // Определить цвет ячейки (как в портале):
                    // - Зеленый (#34d399) — есть фиксация (как в портале)
                    // - Красный (#f87171) — день занятия, дата не позже сегодня и дата не раньше приема, но нет фиксации
                    // - Серый (#e2e8f0) — остальные случаи (включая дни до приема)
                    let bgColor, textColor;

                    if (hasAttendance) {
                        // Есть фиксация через face ID в этот день - всегда зеленый
                        bgColor = '#34d399';
                        textColor = '#ffffff';
                    } else if (isLesson && isAfterAdm && isPastOrToday) {
                        // День занятия, уже наступил (или сегодня), но нет фиксации - красный
                        bgColor = '#f87171';
                        textColor = '#ffffff';
                    } else {
                        // Не день занятия, будущее занятие или дата до приема - серый
                        bgColor = '#e2e8f0';
                        textColor = 'var(--theme-text-secondary)';
                    }

                    const borderStyle = isToday ? '2px solid #667eea' : '1px solid transparent';

                    html += `
                        <div 
                            class="attendance-day-cell" 
                            style="
                                aspect-ratio: 1; 
                                background: ${bgColor}; 
                                border-radius: 4px; 
                                border: ${borderStyle};
                                cursor: pointer;
                                transition: all 0.2s ease;
                                position: relative;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            "
                            data-date="${dateStr}"
                            title="${dateStr}${hasAttendance ? ' - Посещение зафиксировано' : ''}"
                            onmouseover="this.style.transform='scale(1.1)'; this.style.zIndex='10';"
                            onmouseout="this.style.transform='scale(1)'; this.style.zIndex='1';"
                        >
                            <span style="font-size: 10px; font-weight: 500; color: ${textColor}; line-height: 1;">${day}</span>
                        </div>
                    `;
                }

                // Пустые ячейки после последнего дня месяца
                const totalCells = startDayOfWeek + daysInMonth;
                const remainingCells = 7 - (totalCells % 7);
                if (remainingCells < 7) {
                    for (let i = 0; i < remainingCells; i++) {
                        html += '<div style="aspect-ratio: 1; border-radius: 4px;"></div>';
                    }
                }

                html += `
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // Обработчик кнопок редактирования оплаты (делегирование событий)
        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('edit-payment-btn') || e.target.closest('.edit-payment-btn')) {
                const btn = e.target.classList.contains('edit-payment-btn') ? e.target : e.target.closest('.edit-payment-btn');
                const paymentId = btn.getAttribute('data-payment-id');
                const studentId = btn.getAttribute('data-student-id');
                const paymentDataStr = btn.getAttribute('data-payment-data');

                if (!paymentId || !paymentDataStr) return;

                try {
                    // Использовать данные, сохраненные в data-атрибуте
                    const payment = JSON.parse(paymentDataStr);

                    // Заполнить форму
                    document.getElementById('edit_payment_id').value = paymentId;
                    document.getElementById('edit_payment_amount').value = payment.amount_paid || '';

                    // Установить дату
                    if (payment.payment_date) {
                        let date;
                        if (typeof payment.payment_date === 'string') {
                            // Если дата в формате ISO или другом строковом формате
                            date = new Date(payment.payment_date);
                        } else {
                            date = new Date(payment.payment_date);
                        }
                        // Проверить, что дата валидна
                        if (!isNaN(date.getTime())) {
                            const dateStr = date.toISOString().slice(0, 10);
                            document.getElementById('edit_payment_date').value = dateStr;
                        }
                    }

                    // Установить тип оплаты
                    const paymentType = payment.payment_type || 'cash';
                    document.getElementById('edit_payment_type').value = paymentType;

                    // Активировать соответствующую кнопку типа оплаты
                    document.querySelectorAll('.edit-payment-type-btn').forEach(btn => {
                        btn.classList.remove('active');
                        const btnBorder = '2px solid var(--theme-input-border)';
                        const btnBg = 'var(--theme-input-bg)';
                        const btnColor = 'var(--theme-text-primary)';
                        btn.style.border = btnBorder;
                        btn.style.background = btnBg;
                        btn.style.color = btnColor;
                    });

                    const activeBtn = document.querySelector(`.edit-payment-type-btn[data-payment-type="${paymentType}"]`);
                    if (activeBtn) {
                        activeBtn.classList.add('active');
                        activeBtn.style.border = '2px solid #667eea';
                        activeBtn.style.background = 'linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%)';
                        activeBtn.style.color = '#667eea';
                    }

                    // Установить примечание
                    document.getElementById('edit_payment_notes').value = payment.notes || '';

                    // Сохранить studentId в data-атрибуте формы
                    document.getElementById('editPaymentForm').setAttribute('data-student-id', studentId);

                    // Загрузить информацию о тарифе студента
                    loadStudentTariffInfo(studentId, paymentId);

                    // Открыть модальное окно
                    document.getElementById('editPaymentModal').style.display = 'block';
                } catch (error) {
                    console.error('Ошибка парсинга данных оплаты:', error);
                    alert('Ошибка загрузки данных оплаты');
                }
            }
        });

        // Обработчики для кнопок выбора типа оплаты в модалке редактирования
        document.querySelectorAll('.edit-payment-type-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                // Убрать активное состояние со всех кнопок
                document.querySelectorAll('.edit-payment-type-btn').forEach(b => {
                    b.classList.remove('active');
                    const border = '2px solid var(--theme-input-border)';
                    const bg = 'var(--theme-input-bg)';
                    const color = 'var(--theme-text-primary)';
                    b.style.border = border;
                    b.style.background = bg;
                    b.style.color = color;
                });

                // Активировать выбранную кнопку
                this.classList.add('active');
                this.style.border = '2px solid #667eea';
                this.style.background = 'linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%)';
                this.style.color = '#667eea';

                // Обновить скрытое поле
                const paymentType = this.getAttribute('data-payment-type');
                document.getElementById('edit_payment_type').value = paymentType;
            });
        });

        // Закрытие модального окна редактирования оплаты
        const editPaymentClose = document.querySelector('.edit-payment-close');
        if (editPaymentClose) {
            editPaymentClose.addEventListener('click', function () {
                document.getElementById('editPaymentModal').style.display = 'none';
                // Скрыть ошибку при закрытии
                const errorDiv = document.getElementById('edit_payment_amount_error');
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                    errorDiv.textContent = '';
                }
            });
        }

        // Закрытие модального окна при клике вне его
        window.addEventListener('click', function (e) {
            const modal = document.getElementById('editPaymentModal');
            if (e.target === modal) {
                modal.style.display = 'none';
                // Скрыть ошибку при закрытии
                const errorDiv = document.getElementById('edit_payment_amount_error');
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                    errorDiv.textContent = '';
                }
            }
        });

        // Загрузка информации о тарифе студента для валидации
        async function loadStudentTariffInfo(studentId, paymentId) {
            try {
                // Загрузить данные студента
                const studentResponse = await fetch(`/api/students/${studentId}`);
                if (studentResponse.ok) {
                    const student = await studentResponse.json();
                    if (student.tariff_price) {
                        document.getElementById('edit_payment_tariff_price').value = student.tariff_price;
                    }
                }

                // Загрузить данные оплаты для получения месяца и года
                const paymentsResponse = await fetch(`/api/students/${studentId}/monthly-payments`);
                if (paymentsResponse.ok) {
                    const data = await paymentsResponse.json();
                    if (data.payments_by_month) {
                        // Найти оплату по ID и получить месяц/год
                        for (const monthKey in data.payments_by_month) {
                            const month = data.payments_by_month[monthKey];
                            if (month.payments) {
                                const payment = month.payments.find(p => p.id == paymentId);
                                if (payment) {
                                    // Извлечь месяц и год из ключа (формат: YYYY-MM)
                                    const [year, month] = monthKey.split('-');
                                    document.getElementById('edit_payment_payment_year').value = year;
                                    document.getElementById('edit_payment_payment_month').value = parseInt(month);
                                    break;
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки информации о тарифе:', error);
            }
        }

        // Валидация суммы при вводе
        const editPaymentAmountInput = document.getElementById('edit_payment_amount');
        if (editPaymentAmountInput) {
            editPaymentAmountInput.addEventListener('input', function () {
                validatePaymentAmount();
            });
        }

        function validatePaymentAmount() {
            const amountInput = document.getElementById('edit_payment_amount');
            const errorDiv = document.getElementById('edit_payment_amount_error');
            const tariffPrice = parseFloat(document.getElementById('edit_payment_tariff_price').value);

            if (!amountInput || !errorDiv) return;

            const amount = parseFloat(amountInput.value);

            // Скрыть ошибку если поле пустое
            if (!amountInput.value || isNaN(amount)) {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
                return;
            }

            // Проверить превышение тарифа
            if (tariffPrice && amount > tariffPrice) {
                const excess = amount - tariffPrice;
                errorDiv.style.display = 'block';
                errorDiv.textContent = `Сумма превышает стоимость тарифа на ${excess.toLocaleString('ru-RU')} сум`;
                errorDiv.style.color = '#ef4444';
            } else {
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
            }
        }

        // Обработчик формы редактирования оплаты
        const editPaymentForm = document.getElementById('editPaymentForm');
        if (editPaymentForm) {
            editPaymentForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const paymentId = document.getElementById('edit_payment_id').value;
                const studentId = this.getAttribute('data-student-id');
                const amount = parseFloat(document.getElementById('edit_payment_amount').value);
                const paymentDate = document.getElementById('edit_payment_date').value;
                const paymentType = document.getElementById('edit_payment_type').value;
                const notes = document.getElementById('edit_payment_notes').value;
                const tariffPrice = parseFloat(document.getElementById('edit_payment_tariff_price').value);

                if (!paymentId || !amount || amount <= 0) {
                    alert('Заполните все обязательные поля');
                    return;
                }

                // Проверка превышения тарифа перед отправкой
                if (tariffPrice && amount > tariffPrice) {
                    const excess = amount - tariffPrice;
                    const errorDiv = document.getElementById('edit_payment_amount_error');
                    if (errorDiv) {
                        errorDiv.style.display = 'block';
                        errorDiv.textContent = `Сумма превышает стоимость тарифа на ${excess.toLocaleString('ru-RU')} сум`;
                        errorDiv.style.color = '#ef4444';
                    }
                    return; // Не отправлять форму
                }

                try {
                    const response = await fetch(`/api/payments/${paymentId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            amount_paid: amount,
                            payment_date: paymentDate,
                            payment_type: document.getElementById('edit_payment_type').value,
                            notes: notes
                        })
                    });

                    // Проверить, что ответ является JSON
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await response.text();
                        console.error('Ожидался JSON, получен:', text.substring(0, 200));
                        alert('Ошибка: Сервер вернул неверный формат ответа');
                        return;
                    }

                    const data = await response.json();

                    if (!response.ok) {
                        alert('Ошибка: ' + (data.message || `HTTP ${response.status}`));
                        return;
                    }

                    if (data.success) {
                        alert('✓ Оплата успешно обновлена!');
                        document.getElementById('editPaymentModal').style.display = 'none';

                        // Скрыть ошибку
                        const errorDiv = document.getElementById('edit_payment_amount_error');
                        if (errorDiv) {
                            errorDiv.style.display = 'none';
                            errorDiv.textContent = '';
                        }

                        // Перезагрузить историю оплат
                        if (studentId) {
                            loadStudentPayments(studentId);
                        }
                    } else {
                        // Показать ошибку от сервера
                        const errorDiv = document.getElementById('edit_payment_amount_error');
                        if (errorDiv && data.message) {
                            errorDiv.style.display = 'block';
                            errorDiv.textContent = data.message;
                            errorDiv.style.color = '#ef4444';
                        } else {
                            alert('Ошибка: ' + (data.message || 'Не удалось обновить оплату'));
                        }
                    }
                } catch (error) {
                    console.error('Ошибка обновления оплаты:', error);
                    alert('Ошибка обновления оплаты: ' + error.message);
                }
            });
        }

        // Обработчик кнопок удаления оплаты
        document.addEventListener('click', async function (e) {
            const btn = e.target.closest('.delete-payment-btn');
            if (!btn) return;

            e.preventDefault();
            e.stopPropagation();

            const paymentId = btn.getAttribute('data-payment-id');
            const studentId = btn.getAttribute('data-student-id');

            if (!paymentId || !confirm('Вы уверены, что хотите удалить эту оплату?')) {
                return;
            }

            try {
                const response = await fetch(`/api/payments/${paymentId}/delete`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    alert('✓ Оплата успешно удалена!');
                    // Перезагрузить историю оплат для этого ученика
                    if (studentId) {
                        loadStudentPayments(studentId);
                    } else {
                        location.reload();
                    }
                } else {
                    alert('Ошибка: ' + (data.message || 'Не удалось удалить оплату'));
                }
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        });

        // Обработчик кнопки удаления вознаграждения
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.delete-reward-btn');
            if (!btn) return;

            e.preventDefault();
            e.stopPropagation();

            const rewardId = btn.getAttribute('data-reward-id');
            const studentId = btn.getAttribute('data-student-id');

            if (!rewardId || !studentId) return;

            if (!confirm('Вы уверены, что хотите удалить это вознаграждение?')) {
                return;
            }

            fetch(`/api/students/${studentId}/rewards/${rewardId}/delete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => Promise.reject(new Error(data.message || 'Ошибка сервера')));
                    }
                    return response.json();
                })
                .then(async data => {
                    if (data.success) {
                        // Перезагрузить историю вознаграждений
                        if (typeof loadStudentHistory === 'function') {
                            await loadStudentHistory(studentId);
                        }
                    } else {
                        console.error('Ошибка удаления вознаграждения:', data);
                        alert('Ошибка: ' + (data.message || 'Не удалось удалить вознаграждение'));
                    }
                })
                .catch(error => {
                    console.error('Ошибка при удалении вознаграждения:', error);
                    alert('Ошибка при удалении вознаграждения: ' + error.message);
                });
        });

        // Обработчик кнопки удаления карточки
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.delete-card-btn');
            if (!btn) return;

            e.preventDefault();
            e.stopPropagation();

            const cardId = btn.getAttribute('data-card-id');
            const studentId = btn.getAttribute('data-student-id');

            if (!cardId || !studentId) return;

            if (!confirm('Вы уверены, что хотите удалить эту карточку?')) {
                return;
            }

            fetch(`/api/students/${studentId}/cards/${cardId}/delete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
                .then(response => response.json())
                .then(async data => {
                    if (data.success) {
                        // Перезагрузить историю карточек
                        if (typeof loadStudentHistory === 'function') {
                            await loadStudentHistory(studentId);
                        }
                    } else {
                        alert('Ошибка: ' + (data.message || 'Не удалось удалить карточку'));
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка при удалении карточки');
                });
        });

        // Обработчик кнопок возврата оплаты
        document.addEventListener('click', async function (e) {
            const btn = e.target.closest('.refund-payment-btn');
            if (!btn) return;

            e.preventDefault();
            e.stopPropagation();

            const paymentId = btn.getAttribute('data-payment-id');
            const studentId = btn.getAttribute('data-student-id');
            const amount = btn.getAttribute('data-payment-amount');

            if (!paymentId) return;

            if (!confirm(`Вы уверены, что хотите вернуть оплату на сумму ${parseFloat(amount).toLocaleString('ru-RU')} сум?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/payments/${paymentId}/refund`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.success) {
                    alert('✓ Возврат оплаты выполнен успешно!');
                    // Перезагрузить историю оплат для этого ученика
                    if (studentId) {
                        loadStudentPayments(studentId);
                    } else {
                        location.reload();
                    }
                } else {
                    alert('Ошибка: ' + (data.message || 'Не удалось вернуть оплату'));
                }
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        });

        // Обработчик кнопки копирования кода Telegram
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.btn-copy-code');
            if (!btn) return;

            e.preventDefault();
            e.stopPropagation();

            const code = btn.getAttribute('data-code');
            if (!code || code === '' || code === 'Генерируется...') {
                alert('Код еще не сгенерирован. Сохраните ученика, чтобы получить код.');
                return;
            }

            // Копировать в буфер обмена
            navigator.clipboard.writeText(code).then(() => {
                // Показать уведомление
                const originalHTML = btn.innerHTML;
                const originalBackground = btn.style.background || '#f3f4f6';
                const svgSize = btn.querySelector('svg') ? btn.querySelector('svg').getAttribute('width') : '16';
                btn.innerHTML = `<svg width="${svgSize}" height="${svgSize}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 16.17L4.83 12L3.41 13.41L9 19L21 7L19.59 5.59L9 16.17Z" fill="#10b981"/></svg>`;
                btn.style.background = '#d1fae5';

                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.style.background = originalBackground;
                }, 2000);
            }).catch(err => {
                // Fallback для старых браузеров
                const textArea = document.createElement('textarea');
                textArea.value = code;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert('Код скопирован: ' + code);
                } catch (err) {
                    alert('Не удалось скопировать. Код: ' + code);
                }
                document.body.removeChild(textArea);
            });
        });

        // Обработчик кнопки копирования текста (телефоны и др.)
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.btn-copy-text');
            if (!btn) return;

            e.preventDefault();
            e.stopPropagation();

            const text = btn.getAttribute('data-text');
            if (!text || text === '' || text === '-') {
                return;
            }

            // Копировать в буфер обмена
            navigator.clipboard.writeText(text).then(() => {
                // Показать уведомление
                const originalHTML = btn.innerHTML;
                const originalBackground = btn.style.background || '#f3f4f6';
                const svgSize = btn.querySelector('svg') ? btn.querySelector('svg').getAttribute('width') : '14';
                btn.innerHTML = `<svg width="${svgSize}" height="${svgSize}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 16.17L4.83 12L3.41 13.41L9 19L21 7L19.59 5.59L9 16.17Z" fill="#10b981"/></svg>`;
                btn.style.background = '#d1fae5';

                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.style.background = originalBackground;
                }, 2000);
            }).catch(err => {
                // Fallback для старых браузеров
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert('Скопировано: ' + text);
                } catch (err) {
                    alert('Не удалось скопировать. Текст: ' + text);
                }
                document.body.removeChild(textArea);
            });
        });

        // Убедиться, что у всех учеников есть код Telegram
        document.addEventListener('DOMContentLoaded', function () {
            // Проверить коды для всех учеников на странице
            const codeElements = document.querySelectorAll('[id^="telegram_code_"]');
            codeElements.forEach(element => {
                const code = element.textContent.trim();
                if (!code || code === 'Генерируется...' || code === '-') {
                    // Извлечь studentId из id (может быть telegram_code_123 или telegram_code_main_123)
                    const studentId = element.id.replace(/^telegram_code_(main_)?/, '');
                    // Запросить код с сервера
                    fetch(`/api/students/${studentId}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.telegram_link_code) {
                                element.textContent = data.telegram_link_code;
                                // Найти кнопку копирования - может быть родителем или соседом
                                const btn = element.closest('.btn-copy-code') || element.nextElementSibling;
                                if (btn && btn.classList.contains('btn-copy-code')) {
                                    btn.setAttribute('data-code', data.telegram_link_code);
                                } else {
                                    // Если кнопка не найдена, поищем в родителе
                                    const parent = element.parentElement;
                                    if (parent) {
                                        const btnInParent = parent.querySelector('.btn-copy-code');
                                        if (btnInParent) {
                                            btnInParent.setAttribute('data-code', data.telegram_link_code);
                                        }
                                    }
                                }
                            }
                        })
                        .catch(err => console.error('Ошибка загрузки кода:', err));
                }
            });
        });

    </script>
    <script>
        /* Скрипт автоматического редизайна списка учеников под стиль "Мессенджер" */
        document.addEventListener('DOMContentLoaded', () => {
            // Задержка чтобы дать основному скрипту отработать (на всякий)
            setTimeout(() => {
                const oldItems = document.querySelectorAll('.student-list-item');

                oldItems.forEach(item => {
                    // Защита от повторного применения
                    if (item.querySelector('.student-item-content')) return;

                    // --- 1. Извлекаем данные из старой верстки ---
                    // Пробуем разные селекторы, так как верстка могла меняться
                    let nameNode = item.querySelector('.student-name');
                    if (!nameNode) nameNode = item.querySelector('.student-item-name');
                    if (!nameNode) nameNode = item.querySelector('strong');

                    const name = nameNode ? nameNode.innerText.trim() : 'Ученик';

                    let groupNode = item.querySelector('.student-group');
                    if (!groupNode) groupNode = item.querySelector('.student-item-group');
                    const group = groupNode ? groupNode.innerText.trim() : '';

                    const ageNode = item.querySelector('.student-age');
                    const age = ageNode ? ageNode.innerText.trim() : '';

                    // Аватар (ищем img)
                    const imgNode = item.querySelector('img');
                    const imgSrc = imgNode ? imgNode.src : '';

                    // Статусы (должник и т.д.)
                    const isDebtor = item.classList.contains('debtor') || (item.style.borderLeftColor === 'rgb(239, 68, 68)');

                    // --- 2. Формируем новую верстку ---
                    let avatarHtml = '';
                    if (imgSrc && !imgSrc.includes('placeholder')) {
                        avatarHtml = `<img src="${imgSrc}" class="student-avatar-small" onerror="this.src='https://via.placeholder.com/42/e2e8f0/94a3b8?text=👤'">`;
                    } else {
                        avatarHtml = `<div class="student-avatar-small" style="background:#e2e8f0; display:flex; align-items:center; justify-content:center; color:#94a3b8; font-size:18px;">👤</div>`;
                    }

                    const newInner = `
                    ${avatarHtml}
                    <div class="student-item-content">
                        <div class="student-item-head">
                            <span class="student-item-name" style="${isDebtor ? 'color:#ef4444' : ''}">${name}</span>
                            ${age ? `<span class="student-item-age">${age}</span>` : ''}
                        </div>
                        <div class="student-item-sub">
                            ${group ? `<span class="student-item-group">${group}</span>` : '<span class="student-item-group" style="color:#cbd5e1">Без группы</span>'}
                            ${isDebtor ? `<span style="color:#ef4444; font-weight:bold; margin-left:6px; font-size:10px;">ДОЛГ</span>` : ''}
                        </div>
                    </div>
                `;

                    // --- 3. Подменяем содержимое ---
                    item.innerHTML = newInner;
                    item.style.borderLeft = 'none';
                });
            }, 100);
        });
    </script>
    <script>
        /* Скрипт для открытия модалки добавления через URL параметр */
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('add') === 'true') {
                const addBtn = document.getElementById('addStudentBtn');
                if (addBtn) {
                    setTimeout(() => addBtn.click(), 500);
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }

            // Синхронизация кликов для мобильной и десктопной кнопок добавления
            const mobileAddBtn = document.getElementById('mobileAddStudentBtn');
            const desktopAddBtn = document.getElementById('addStudentBtn');

            if (mobileAddBtn && desktopAddBtn) {
                mobileAddBtn.addEventListener('click', () => {
                    desktopAddBtn.click();
                });
            }
        });
        /* Скрипт для поиска в шапке на мобилке */
        document.addEventListener('DOMContentLoaded', () => {
            const toggleSearch = document.getElementById('toggleMobileSearch');
            const closeSearch = document.getElementById('closeMobileSearch');
            const searchBar = document.getElementById('mobileSearchBar');
            const topBar = document.querySelector('.game-top-bar');
            const mobileInput = document.getElementById('mobileSearchInput');
            const mainSearchInput = document.getElementById('studentListSearch');

            if (toggleSearch && searchBar) {
                toggleSearch.addEventListener('click', () => {
                    topBar.classList.add('mobile-search-active');
                    mobileInput.focus();
                });

                closeSearch.addEventListener('click', () => {
                    topBar.classList.remove('mobile-search-active');
                    mobileInput.value = '';
                    // Синхронизируем с основным поиском
                    if (mainSearchInput) {
                        mainSearchInput.value = '';
                        mainSearchInput.dispatchEvent(new Event('input'));
                    }
                });

                mobileInput.addEventListener('input', (e) => {
                    if (mainSearchInput) {
                        mainSearchInput.value = e.target.value;
                        mainSearchInput.dispatchEvent(new Event('input'));
                    }
                });
            }

            window.addEventListener('resize', () => {
                if (window.innerWidth >= 769 && topBar) {
                    topBar.classList.remove('mobile-search-active');
                }
            });

            // Логика выбора группы снизу
            const toggleGroup = document.getElementById('toggleMobileGroupFilter');
            const groupOverlay = document.getElementById('mobileGroupFilterOverlay');
            const closeGroup = document.getElementById('closeMobileGroup');
            const groupSelect = document.getElementById('groupFilterSelect');
            const groupList = document.getElementById('mobileGroupList');

            if (toggleGroup && groupOverlay) {
                toggleGroup.addEventListener('click', () => {
                    // Генерируем список групп из основного селекта
                    let html = '<button class="bottom-sheet-item ' + (!groupSelect.value ? 'active' : '') + '" data-value="">Все группы</button>';
                    Array.from(groupSelect.options).forEach(opt => {
                        if (opt.value) {
                            html += `<button class="bottom-sheet-item ${groupSelect.value === opt.value ? 'active' : ''}" data-value="${opt.value}">${opt.textContent}</button>`;
                        }
                    });
                    groupList.innerHTML = html;
                    groupOverlay.classList.add('active');
                });

                closeGroup.addEventListener('click', () => {
                    groupOverlay.classList.remove('active');
                });

                groupOverlay.addEventListener('click', (e) => {
                    if (e.target === groupOverlay) groupOverlay.classList.remove('active');
                });

                groupList.addEventListener('click', (e) => {
                    const btn = e.target.closest('.bottom-sheet-item');
                    if (btn) {
                        const val = btn.getAttribute('data-value');
                        groupSelect.value = val;
                        groupSelect.dispatchEvent(new Event('change'));
                        groupOverlay.classList.remove('active');
                    }
                });
            }
        });
    </script>

    <!-- Bottom Sheet для выбора группы -->
    <div class="mobile-bottom-sheet-overlay" id="mobileGroupFilterOverlay">
        <div class="mobile-bottom-sheet">
            <div class="bottom-sheet-header">
                <h3>Выберите группу</h3>
                <button id="closeMobileGroup" class="game-btn game-btn-secondary"
                    style="padding: 5px 10px !important;">✕</button>
            </div>
            <div class="bottom-sheet-list" id="mobileGroupList">
                <!-- Заполнится через JS -->
            </div>
        </div>
    </div>
</body>

</html>